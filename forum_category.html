<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Category — Scream Collector</title>
<style>
  :root{--bg:#111;--panel:#1b1b1b;--ink:#eee;--muted:#a9adb4}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:Arial,Helvetica,sans-serif}
  a{color:#9ecbff;text-decoration:none}
  .wrap{max-width:1000px;margin:0 auto;padding:24px}
  .card{background:var(--panel);border-radius:12px;padding:16px;margin-top:16px}
  .muted{color:var(--muted)} .ok{color:#9f9}.err{color:#f88}
  .list{list-style:none;margin:0;padding:0}
  .row{display:flex;align-items:center;justify-content:space-between;gap:10px}
  .node{padding:12px;border:1px solid #2a2a2a;background:#161616;border-radius:10px;margin-bottom:10px}
  .btn{background:#444;color:#fff;border:none;border-radius:8px;padding:6px 10px;cursor:pointer;text-decoration:none}
  input{padding:8px;border-radius:6px;border:1px solid #333;background:#222;color:#eee}
  .post{padding:12px;border:1px solid #2a2a2a;background:#161616;border-radius:10px;margin-bottom:10px}
</style>
</head>
<body>
<app-menu></app-menu>
<script type="module" src="/menu.js"></script>

<div class="wrap">
  <a href="forum.html">← Forum</a>
  <h2 id="catTitle">Category</h2>

  <!-- For moderators: create a subcategory here -->
  <div id="modBox" class="card" style="display:none">
    <h3 style="margin:0 0 8px">Moderator: Add Subcategory</h3>
    <div class="row">
      <input id="subTitle" placeholder="Subcategory title (e.g., Scream 2)"/>
      <button id="addSub" class="btn" style="background:#2a6">Create</button>
      <span id="modMsg" class="muted"></span>
    </div>
  </div>

  <!-- If category has children, list them here. Otherwise, show posts. -->
  <div id="childrenCard" class="card" style="display:none">
    <h3 style="margin:0 0 8px">Subcategories</h3>
    <ul id="childrenList" class="list"></ul>
    <div class="muted">Open one to continue. You can only create posts in the deepest category.</div>
  </div>

  <div id="postsCard" class="card" style="display:none">
    <div class="row" style="margin-bottom:8px">
      <h3 style="margin:0">Posts</h3>
      <div id="postActions"></div>
    </div>
    <div id="postsStatus" class="muted">Loading…</div>
    <div id="postsList"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
(function(){
  const sb = supabase.createClient(
    'https://wktxpukjmvmhzpctttjx.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndrdHhwdWtqbXZtaHpwY3R0dGp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxMjg2MjAsImV4cCI6MjA3MTcwNDYyMH0.07xzRjb_iQlkaObfslKiL9VZIHT8P3vnK-ZkIVm2qVY'
  );

  const qs = new URLSearchParams(location.search);
  const catId = qs.get('id');

  const catTitleEl = document.getElementById('catTitle');
  const modBox = document.getElementById('modBox');
  const subTitle = document.getElementById('subTitle');
  const addSub = document.getElementById('addSub');
  const modMsgEl = document.getElementById('modMsg');

  const childrenCard = document.getElementById('childrenCard');
  const childrenList = document.getElementById('childrenList');

  const postsCard = document.getElementById('postsCard');
  const postsList = document.getElementById('postsList');
  const postsStatus = document.getElementById('postsStatus');
  const postActions = document.getElementById('postActions');

  let myRole='free', me=null;

  const setModMsg=(t,cls='muted')=>{modMsgEl.className=cls;modMsgEl.textContent=t;};
  const escapeHtml=s=>String(s||'').replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));

  (async function init(){
    if (!catId){ location.href='forum.html'; return; }

    const { data:{ session } } = await sb.auth.getSession();
    me = session?.user || null;
    if (me){
      const { data:p } = await sb.from('profiles').select('role').eq('id',me.id).maybeSingle();
      myRole = p?.role || 'free';
    }
    if (myRole==='moderator') modBox.style.display='block';

    // load category title
    const { data: cat, error: ce } = await sb.from('forum_categories').select('id,title').eq('id', catId).maybeSingle();
    if (ce){ catTitleEl.textContent='Error loading category'; console.error(ce); return; }
    if (!cat){ catTitleEl.textContent='Category not found'; return; }
    catTitleEl.textContent = cat.title;

    // load children
    const { data: kids, error: ke } = await sb.from('forum_categories')
      .select('id,title')
      .eq('parent_id', catId)
      .order('title',{ascending:true});

    if (ke){ console.error(ke); }

    if (kids?.length){
      // not a leaf: show subcategories only
      childrenCard.style.display='block';
      childrenList.innerHTML = kids.map(c=>`
        <li class="node">
          <div class="row">
            <strong>${escapeHtml(c.title)}</strong>
            <div class="row">
              <a class="btn" href="forum_category.html?id=${c.id}">Open</a>
              ${myRole==='moderator'
                ? `<button class="btn" data-act="addSub" data-id="${c.id}">Add Sub</button>
                   <button class="btn" style="background:#933" data-act="delCat" data-id="${c.id}">Delete</button>`
                : ''
              }
            </div>
          </div>
        </li>
      `).join('');
    } else {
      // leaf: show posts
      postsCard.style.display='block';
      if (myRole!=='free'){
        const newBtn = document.createElement('a');
        newBtn.href = `forum_new_post.html?cat=${catId}`;
        newBtn.className = 'btn';
        newBtn.style.background = '#2a6';
        newBtn.textContent = 'New Post';
        postActions.appendChild(newBtn);
      }
      await loadPosts();
    }
  })();

  async function loadPosts(){
    postsStatus.textContent='Loading…';

    // 1) posts (no joins)
    const { data: posts, error: pe } = await sb
      .from('forum_posts')
      .select('id,title,created_at,author_id')
      .eq('category_id', catId)
      .order('created_at',{ascending:false});
    if (pe){ postsStatus.textContent='Error: '+pe.message; return; }

    if (!posts?.length){ postsStatus.textContent='No posts yet.'; postsList.innerHTML=''; return; }

    // 2) authors
    const authorIds = [...new Set(posts.map(p=>p.author_id).filter(Boolean))];
    let authorsById = {};
    if (authorIds.length){
      const { data: authors, error: ae } = await sb
        .from('profiles')
        .select('id,username,avatar_url,frame_url,frame_scale,post_count,reply_count')
        .in('id', authorIds);
      if (!ae && authors){
        authorsById = Object.fromEntries(authors.map(a=>[a.id,a]));
      }
    }

    // 3) replies for these posts (for the per-post reply count)
    const postIds = posts.map(p=>p.id);
    let replyCountByPost = {};
    if (postIds.length){
      const { data: reps, error: re } = await sb
        .from('forum_replies')
        .select('post_id')
        .in('post_id', postIds);
      if (!re && reps){
        for (const r of reps){
          replyCountByPost[r.post_id] = (replyCountByPost[r.post_id]||0) + 1;
        }
      }
    }

    postsStatus.textContent='';
    postsList.innerHTML = posts.map(p=>{
      const a = authorsById[p.author_id];
      const authorHtml = a?.username
        ? `<a href="user.html?u=${encodeURIComponent(a.username)}">@${a.username}</a>`
        : 'unknown';
      const totalContrib = Number(a?.post_count||0) + Number(a?.reply_count||0);
      const rcount = replyCountByPost[p.id] || 0;
      return `
        <div class="post">
          <div class="row">
            <a href="forum_post.html?id=${p.id}"><strong>${escapeHtml(p.title)}</strong></a>
            <span class="muted">${new Date(p.created_at).toLocaleString()}</span>
          </div>
          <div class="muted" style="margin-top:6px">
            by ${authorHtml} • Replies: ${rcount} • Posts: ${totalContrib}
          </div>
        </div>
      `;
    }).join('');
  }

  // moderator actions on child list
  childrenList.addEventListener('click', async (e)=>{
    const btn = e.target.closest('button[data-act]');
    if (!btn) return;
    const act = btn.dataset.act;
    const id  = btn.dataset.id;

    if (act==='addSub'){
      const t = prompt('Subcategory title?'); if(!t) return;
      const { data:{ session } } = await sb.auth.getSession();
      const uid = session?.user?.id || null;
      const { error } = await sb.from('forum_categories').insert({ title:t.trim(), parent_id:id, created_by:uid });
      if (error) return setModMsg('Error: '+error.message,'err');
      setModMsg('Created.','ok'); location.reload();
    }
    if (act==='delCat'){
      if(!confirm('Delete this category and all descendants (posts & replies included)?')) return;
      const { error } = await sb.from('forum_categories').delete().eq('id', id);
      if (error) return setModMsg('Error: '+error.message,'err');
      setModMsg('Deleted.','ok'); location.reload();
    }
  });
})();
</script>
</body>
</html>
