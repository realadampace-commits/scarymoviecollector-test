<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Account Settings</title>
<style>
  :root{--panel:#1c1c1c;--muted:#a9adb4}
  body{margin:0;background:#111;color:#eee;font-family:Arial,Helvetica,sans-serif}
  .wrap{max-width:840px;margin:0 auto;padding:24px}
  a{color:#9ecbff;text-decoration:none}
  .card{background:var(--panel);border-radius:12px;padding:16px;margin-top:16px}
  .row{display:grid;grid-template-columns:160px 1fr;gap:16px;align-items:center}
  input,button,textarea{padding:10px;border-radius:6px;border:1px solid #333;background:#222;color:#eee}
  button{border:none;background:crimson;cursor:pointer}
  .muted{color:var(--muted)}
  .ok{color:#9f9}.err{color:#f88}
  .tools{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  /* avatar + frame */
  .avatarWrap{position:relative;width:120px;height:120px}
  .avatar{width:120px;height:120px;border-radius:50%;background:#222;overflow:hidden;display:flex;align-items:center;justify-content:center}
  .avatar img{max-width:100%;max-height:100%}
  .frameOverlay{
    position:absolute;inset:0;
    background-size:contain;background-position:center;background-repeat:no-repeat;
    pointer-events:none;transform-origin:center;
    transform:scale(var(--frameScale,1));
  }
  /* cosmetics gallery */
  .hscroll{display:flex;gap:12px;overflow:auto;padding-bottom:6px}
  .frameCard{min-width:140px;background:#181818;border-radius:10px;border:1px solid #2a2a2a;padding:8px;text-align:center;cursor:pointer}
  .frameThumb{width:100%;aspect-ratio:1/1;display:flex;align-items:center;justify-content:center;background:#0f0f0f;border-radius:8px;overflow:hidden}
  .frameThumb img{max-width:100%;max-height:100%}
  .sel{outline:2px solid #4ade80}
  .dim{opacity:.35;filter:grayscale(.9)}
  .lock{position:absolute;inset:0;background:rgba(0,0,0,.55);display:flex;align-items:center;justify-content:center;border-radius:12px;font-weight:600}
</style>
</head>
<body>
<app-menu></app-menu>
<script type="module" src="/menu.js"></script>

<div class="wrap">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <a href="index.html">← Home</a>
    <a href="portfolio.html" style="background:#444;padding:8px 12px;border-radius:6px;color:#fff;text-decoration:none">My Portfolio</a>
  </div>
  <h2>Account Settings</h2>
  <div id="roleBanner" class="muted" style="margin-top:6px"></div>

  <!-- Avatar -->
  <div class="card">
    <h3>Profile Picture</h3>
    <div class="row">
      <div class="avatarWrap">
        <div class="avatar" id="avatarBox"><span class="muted">No image</span></div>
        <div id="frameOverlay" class="frameOverlay"></div>
      </div>
      <div class="tools">
        <input type="file" id="avatarFile" accept="image/*" />
        <button id="uploadAvatar">Upload</button>
        <span id="avatarMsg" class="muted"></span>
      </div>
    </div>
  </div>

  <!-- Username -->
  <div class="card">
    <h3>Change Username</h3>
    <div class="row">
      <label class="muted">New username</label>
      <div class="tools">
        <input id="username" placeholder="e.g., nate008"/>
        <button id="saveUsername">Save</button>
        <span id="userMsg" class="muted"></span>
      </div>
    </div>
  </div>

  <!-- Bio -->
  <div class="card">
    <h3>Bio</h3>
    <textarea id="bioInput" placeholder="Tell people about yourself…" style="width:100%;height:80px;"></textarea>
    <div class="tools" style="margin-top:8px">
      <button id="saveBio">Save Bio</button>
      <span id="bioMsg" class="muted"></span>
    </div>
  </div>

  <!-- Showcase -->
  <div class="card">
    <h3>Showcase Favorites</h3>
    <p class="muted" style="margin-top:6px">Paste up to 5 item IDs (from item URLs) separated by commas.</p>
    <div class="tools">
      <input id="showcaseInput" placeholder="65a7f..., b91c4..., ..." style="flex:1"/>
      <button id="saveShowcase">Save Showcase</button>
      <span id="showcaseMsg" class="muted"></span>
    </div>
  </div>

  <!-- Cosmetics: Frames (gallery + apply) -->
  <div class="card" style="position:relative">
    <h3 style="margin-bottom:10px">Cosmetics → Profile Picture Frames</h3>

    <div id="lock" class="lock" style="display:none">Subscribe to unlock</div>

    <div id="framesRow" class="hscroll"></div>

    <div class="tools" id="subsTools" style="display:none;margin-top:8px">
      <button id="saveFrame" style="background:#2a6">Use Selected Frame</button>
      <button id="clearFrame" style="background:#555">Remove Frame</button>
      <span id="frameMsg" class="muted"></span>
    </div>

    <!-- Moderator/Owner upload tools -->
    <div id="modTools" style="display:none;margin-top:14px;border-top:1px dashed #333;padding-top:12px">
      <h4 style="margin:0 0 6px">Moderator/Owner: Upload new frame</h4>
      <div class="tools">
        <input id="frameTitle" placeholder="Frame title (optional)"/>
        <input id="frameScale" type="number" step="0.01" min="0.5" max="2" value="1.08" style="width:110px" title="Scale"/>
        <input id="frameFile" type="file" accept="image/*" />
        <button id="uploadFrame">Upload Frame</button>
        <span id="uploadMsg" class="muted"></span>
      </div>
      <div class="muted" style="font-size:12px">Recommended: square PNG with transparency (e.g., 1024×1024).</div>
    </div>
  </div>

  <!-- Password -->
  <div class="card">
    <h3>Change Password (Email Confirmation)</h3>
    <p class="muted">We’ll send a secure reset link to your email.</p>
    <div class="tools">
      <button id="sendReset">Send Password Reset Email</button>
      <span id="pwdMsg" class="muted"></span>
    </div>
  </div>

  <!-- Logout -->
  <div class="card">
    <h3>Sign out</h3>
    <div class="tools">
      <button id="logoutLocal"  style="background:#666">Sign out (this device)</button>
      <button id="logoutGlobal" style="background:#c33">Sign out (all devices)</button>
      <span id="logoutMsg" class="muted"></span>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const sb = supabase.createClient(
  'https://wktxpukjmvmhzpctttjx.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndrdHhwdWtqbXZtaHpwY3R0dGp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxMjg2MjAsImV4cCI6MjA3MTcwNDYyMH0.07xzRjb_iQlkaObfslKiL9VZIHT8P3vnK-ZkIVm2qVY'
);
const AVATAR_BUCKET='avatars', FRAMES_BUCKET='frames';

const roleBanner=document.getElementById('roleBanner');
const avatarBox=document.getElementById('avatarBox');
const avatarFile=document.getElementById('avatarFile');
const uploadAvatarBtn=document.getElementById('uploadAvatar');
const avatarMsg=document.getElementById('avatarMsg');
const frameOverlay=document.getElementById('frameOverlay');

const usernameInput=document.getElementById('username');
const saveUsernameBtn=document.getElementById('saveUsername');
const userMsg=document.getElementById('userMsg');

const bioInput=document.getElementById('bioInput');
const saveBioBtn=document.getElementById('saveBio');
const bioMsg=document.getElementById('bioMsg');

const showcaseInput=document.getElementById('showcaseInput');
const saveShowcaseBtn=document.getElementById('saveShowcase');
const showcaseMsg=document.getElementById('showcaseMsg');

const pwdMsg=document.getElementById('pwdMsg');
const sendResetBtn=document.getElementById('sendReset');

const logoutMsg=document.getElementById('logoutMsg');
const logoutLocalBtn=document.getElementById('logoutLocal');
const logoutGlobalBtn=document.getElementById('logoutGlobal');

const framesRow=document.getElementById('framesRow');
const subsTools=document.getElementById('subsTools');
const modTools=document.getElementById('modTools');
const saveFrameBtn=document.getElementById('saveFrame');
const clearFrameBtn=document.getElementById('clearFrame');
const frameMsg=document.getElementById('frameMsg');
const lockOverlay=document.getElementById('lock');

const frameTitle=document.getElementById('frameTitle');
const frameScaleInput=document.getElementById('frameScale');
const frameFile=document.getElementById('frameFile');
const uploadFrameBtn=document.getElementById('uploadFrame');
const uploadMsg=document.getElementById('uploadMsg');

let user=null, role='free';
let selectedFrameUrl=null, selectedFrameScale=1.0;
let currentFrameUrl=null, currentFrameScale=1.0;

const setMsg=(el,txt,cls='muted')=>{el.className=cls; el.textContent=txt;};
const sanitizeUsername=(u)=>u.toLowerCase().replace(/[^a-z0-9_.-]/g,'').slice(0,30);

(async function init(){
  const { data:{ session } } = await sb.auth.getSession();
  if(!session){ alert('Please log in first.'); location.href='login.html'; return; }
  user=session.user;

  const { data: profile } = await sb.from('profiles')
    .select('username, avatar_url, bio, showcase_ids, role, frame_url, frame_scale')
    .eq('id', user.id).maybeSingle();

  role=profile?.role||'free';
  currentFrameUrl=profile?.frame_url||null;
  currentFrameScale=profile?.frame_scale??1.0;

  if(profile?.avatar_url) avatarBox.innerHTML=`<img src="${profile.avatar_url}" alt="avatar">`;
  if(currentFrameUrl){
    frameOverlay.style.backgroundImage=`url('${currentFrameUrl}')`;
    frameOverlay.style.setProperty('--frameScale', currentFrameScale);
  }
  if(profile?.username) usernameInput.value=profile.username;
  if(profile?.bio) bioInput.value=profile.bio;
  if(profile?.showcase_ids?.length) showcaseInput.value=profile.showcase_ids.join(', ');
  roleBanner.textContent=`Your role: ${role}`;

  // Gallery gating: subscribers, moderators, owners see frames & can apply
  if(role==='free'){ lockOverlay.style.display='flex'; framesRow.classList.add('dim'); }
  else { subsTools.style.display='flex'; await loadFrames(); }

  // Upload gate: moderators OR owners
  if(role==='moderator' || role==='owner'){ modTools.style.display='block'; }
})();

async function loadFrames(){
  framesRow.innerHTML='<div class="muted">Loading frames…</div>';
  const { data: frames, error } = await sb
    .from('frames').select('id,title,image_url,scale,created_by').order('created_at',{ascending:false});
  if(error){ framesRow.innerHTML='<div class="muted err">Failed to load frames.</div>'; return; }
  if(!frames?.length){ framesRow.innerHTML='<div class="muted">No frames uploaded yet.</div>'; return; }

  framesRow.innerHTML = frames.map(fr=>`
    <div class="frameCard ${fr.image_url===currentFrameUrl?'sel':''}"
         data-url="${fr.image_url}" data-scale="${fr.scale??1}">
      <div class="frameThumb"><img src="${fr.image_url}" alt=""></div>
      <div class="muted" style="margin-top:6px;font-size:13px">
        ${fr.title||'Frame'} · ${Math.round((fr.scale??1)*100)}%
      </div>
    </div>
  `).join('');

  framesRow.querySelectorAll('.frameCard').forEach(card=>{
    card.addEventListener('click',()=>{
      framesRow.querySelectorAll('.frameCard').forEach(c=>c.classList.remove('sel'));
      card.classList.add('sel');
      selectedFrameUrl=card.dataset.url;
      selectedFrameScale=parseFloat(card.dataset.scale||'1');
      frameOverlay.style.backgroundImage=`url('${selectedFrameUrl}')`;
      frameOverlay.style.setProperty('--frameScale', selectedFrameScale);
    });
  });
}

// avatar upload
uploadAvatarBtn.addEventListener('click', async ()=>{
  if(!avatarFile.files[0]) return setMsg(avatarMsg,'Choose an image first.','err');
  const file=avatarFile.files[0];
  const safe=file.name.replace(/[^\w.\-]+/g,'_');
  const path=`${user.id}/avatar-${Date.now()}-${safe}`;
  setMsg(avatarMsg,'Uploading…');
  const up=await sb.storage.from(AVATAR_BUCKET).upload(path,file,{upsert:true,contentType:file.type});
  if(up.error) return setMsg(avatarMsg,'Upload error: '+up.error.message,'err');
  const { data:pub }=sb.storage.from(AVATAR_BUCKET).getPublicUrl(path);
  const url=pub.publicUrl;
  const upd=await sb.from('profiles').update({avatar_url:url}).eq('id',user.id);
  if(upd.error) return setMsg(avatarMsg,'Failed saving avatar URL: '+upd.error.message,'err');
  avatarBox.innerHTML=`<img src="${url}" alt="avatar">`;
  setMsg(avatarMsg,'Avatar updated!','ok');
});

// username
saveUsernameBtn.addEventListener('click', async ()=>{
  let uname=sanitizeUsername(usernameInput.value.trim());
  if(!uname) return setMsg(userMsg,'Username cannot be empty.','err');
  const { data:exists }=await sb.from('profiles').select('id').ilike('username',uname).neq('id',user.id).limit(1);
  if(exists && exists.length>0) return setMsg(userMsg,'Username already taken.','err');
  const upd=await sb.from('profiles').update({username:uname}).eq('id',user.id);
  if(upd.error) return setMsg(userMsg,'Failed updating username: '+upd.error.message,'err');
  setMsg(userMsg,'Username updated!','ok');
});

// bio
saveBioBtn.addEventListener('click', async ()=>{
  const bio=bioInput.value.trim();
  const { error }=await sb.from('profiles').update({bio}).eq('id',user.id);
  if(error) return setMsg(bioMsg,'Error: '+error.message,'err');
  setMsg(bioMsg,'Bio updated!','ok');
});

// showcase
saveShowcaseBtn.addEventListener('click', async ()=>{
  const arr=showcaseInput.value.split(',').map(x=>x.trim()).filter(Boolean).slice(0,5);
  const { error }=await sb.from('profiles').update({showcase_ids:arr}).eq('id',user.id);
  if(error) return setMsg(showcaseMsg,'Error: '+error.message,'err');
  setMsg(showcaseMsg,'Showcase updated!','ok');
});

// password reset
sendResetBtn.addEventListener('click', async ()=>{
  setMsg(pwdMsg,'Sending reset email…');
  const redirectTo=window.location.origin+'/reset.html';
  const { error }=await sb.auth.resetPasswordForEmail(user.email,{redirectTo});
  if(error) return setMsg(pwdMsg,'Error: '+error.message,'err');
  setMsg(pwdMsg,'Check your email for the reset link.','ok');
});

// save / clear frame selection
saveFrameBtn.addEventListener('click', async ()=>{
  if(!selectedFrameUrl) return setMsg(frameMsg,'Pick a frame first.','err');
  const { error }=await sb.from('profiles')
    .update({ frame_url:selectedFrameUrl, frame_scale:selectedFrameScale })
    .eq('id',user.id);
  if(error) return setMsg(frameMsg,'Error: '+error.message,'err');
  currentFrameUrl=selectedFrameUrl; currentFrameScale=selectedFrameScale;
  setMsg(frameMsg,'Frame applied!','ok');
});
clearFrameBtn.addEventListener('click', async ()=>{
  const { error }=await sb.from('profiles')
    .update({ frame_url:null, frame_scale:1.0 })
    .eq('id',user.id);
  if(error) return setMsg(frameMsg,'Error: '+error.message,'err');
  selectedFrameUrl=null; selectedFrameScale=1.0;
  currentFrameUrl=null; currentFrameScale=1.0;
  frameOverlay.style.backgroundImage='none';
  frameOverlay.style.setProperty('--frameScale',1);
  framesRow.querySelectorAll('.frameCard').forEach(c=>c.classList.remove('sel'));
  setMsg(frameMsg,'Frame removed.','ok');
});

// moderator/owner upload (allow owner too)
uploadFrameBtn.addEventListener('click', async ()=>{
  const { data: me } = await sb.from('profiles').select('role').eq('id',user.id).maybeSingle();
  if(!(me?.role==='owner')) return setMsg(uploadMsg,'Only the owner can upload.','err');
  const f=frameFile.files[0]; if(!f) return setMsg(uploadMsg,'Choose a PNG with transparency.','err');
  const scaleVal=parseFloat(frameScaleInput.value||'1');
  setMsg(uploadMsg,'Uploading…');
  const safe=f.name.replace(/[^\w.\-]+/g,'_');
  const path=`${user.id}/frame-${Date.now()}-${safe}`;
  const up=await sb.storage.from(FRAMES_BUCKET).upload(path,f,{upsert:true,contentType:f.type});
  if(up.error) return setMsg(uploadMsg,'Upload error: '+up.error.message,'err');
  const { data: pub }=sb.storage.from(FRAMES_BUCKET).getPublicUrl(path);
  const url=pub.publicUrl;
  const ins=await sb.from('frames').insert({
    title:frameTitle.value.trim()||null,
    image_url:url,
    created_by:user.id,
    scale:isFinite(scaleVal)?scaleVal:1.0
  });
  if(ins.error) return setMsg(uploadMsg,'Save error: '+ins.error.message,'err');
  setMsg(uploadMsg,'Frame uploaded!','ok');
  frameTitle.value=''; frameFile.value=''; await loadFrames();
});

// sign out helpers
async function safeSignOut(scope){
  try{
    const { error }=await sb.auth.signOut(scope?{scope}:undefined);
    if(error && error.message!=='Auth session missing!'){ setMsg(logoutMsg,'Error: '+error.message,'err'); return false; }
    return true;
  }catch(e){ setMsg(logoutMsg,'Error: '+(e?.message||e),'err'); return false; }
}
logoutLocalBtn.addEventListener('click', async ()=>{ setMsg(logoutMsg,'Signing out…'); if(await safeSignOut(null)) location.href='index.html'; });
logoutGlobalBtn.addEventListener('click', async ()=>{ setMsg(logoutMsg,'Signing out everywhere…'); if(await safeSignOut('global')) location.href='index.html'; });
</script>
</body>
</html>

