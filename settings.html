<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Account Settings</title>
<style>
  :root{--panel:#1c1c1c;--muted:#a9adb4}
  body{margin:0;background:#111;color:#eee;font-family:Arial,Helvetica,sans-serif}
  .wrap{max-width:840px;margin:0 auto;padding:24px}
  a{color:#9ecbff;text-decoration:none}
  .card{background:var(--panel);border-radius:12px;padding:16px;margin-top:16px}
  .row{display:grid;grid-template-columns:160px 1fr;gap:16px;align-items:center}
  input,button,textarea{padding:10px;border-radius:6px;border:1px solid #333;background:#222;color:#eee}
  button{border:none;background:crimson;cursor:pointer}
  .muted{color:var(--muted)}
  .ok{color:#9f9}.err{color:#f88}
  .tools{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
</style>
</head>
<body>
<app-menu></app-menu>
<script type="module" src="/menu.js"></script>

<div class="wrap">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <a href="index.html">← Home</a>
    <a href="portfolio.html" style="background:#444;padding:8px 12px;border-radius:6px;color:#fff;text-decoration:none">My Portfolio</a>
  </div>
  <h2>Account Settings</h2>
  <div id="roleBanner" class="muted" style="margin-top:6px"></div>

  <!-- USDC (Base) wallet -->
  <div class="card">
    <h3>USDC (Base) Wallet</h3>
    <p class="muted">Enter your Base wallet address (starts with 0x…) to receive USDC for sales. Required to sell. Only <strong>subscribers</strong> (and moderators/owner) can enable selling.</p>
    <div class="tools">
      <input id="usdcAddr" placeholder="0x..." style="min-width:320px">
      <button id="saveUsdc" style="background:#2a6">Save</button>
      <span id="usdcMsg" class="muted"></span>
    </div>
  </div>

  <!-- Basic profile bits kept minimal -->
  <div class="card">
    <h3>Username</h3>
    <div class="row">
      <label class="muted">New username</label>
      <div class="tools">
        <input id="username" placeholder="e.g., nate008"/>
        <button id="saveUsername">Save</button>
        <span id="userMsg" class="muted"></span>
      </div>
    </div>
  </div>

  <div class="card">
    <h3>Bio</h3>
    <textarea id="bioInput" placeholder="Tell people about yourself…" style="width:100%;height:80px;"></textarea>
    <div class="tools" style="margin-top:8px">
      <button id="saveBio">Save Bio</button>
      <span id="bioMsg" class="muted"></span>
    </div>
  </div>

  <div class="card">
    <h3>Sign out</h3>
    <div class="tools">
      <button id="logoutLocal"  style="background:#666">Sign out (this device)</button>
      <button id="logoutGlobal" style="background:#c33">Sign out (all devices)</button>
      <span id="logoutMsg" class="muted"></span>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const sb = supabase.createClient(
  'https://wktxpukjmvmhzpctttjx.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndrdHhwdWtqbXZtaHpwY3R0dGp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxMjg2MjAsImV4cCI6MjA3MTcwNDYyMH0.07xzRjb_iQlkaObfslKiL9VZIHT8P3vnK-ZkIVm2qVY'
);

const roleBanner=document.getElementById('roleBanner');

const usernameInput=document.getElementById('username');
const saveUsernameBtn=document.getElementById('saveUsername');
const userMsg=document.getElementById('userMsg');

const bioInput=document.getElementById('bioInput');
const saveBioBtn=document.getElementById('saveBio');
const bioMsg=document.getElementById('bioMsg');

const logoutMsg=document.getElementById('logoutMsg');
const logoutLocalBtn=document.getElementById('logoutLocal');
const logoutGlobalBtn=document.getElementById('logoutGlobal');

// USDC
const usdcAddr=document.getElementById('usdcAddr');
const saveUsdc=document.getElementById('saveUsdc');
const usdcMsg=document.getElementById('usdcMsg');

let user=null, role='free';

const setMsg=(el,txt,cls='muted')=>{el.className=cls; el.textContent=txt;};
const sanitizeUsername=(u)=>u.toLowerCase().replace(/[^a-z0-9_.-]/g,'').slice(0,30);

(async function init(){
  const { data:{ session } } = await sb.auth.getSession();
  if(!session){ alert('Please log in first.'); location.href='login.html'; return; }
  user=session.user;

  const { data: profile } = await sb.from('profiles')
    .select('username, bio, role, usdc_base_address')
    .eq('id', user.id).maybeSingle();

  role=profile?.role||'free';
  roleBanner.textContent=`Your role: ${role}`;

  if(profile?.username) usernameInput.value=profile.username;
  if(profile?.bio) bioInput.value=profile.bio;
  if(profile?.usdc_base_address) usdcAddr.value = profile.usdc_base_address;
})();

// username
saveUsernameBtn.addEventListener('click', async ()=>{
  let uname=sanitizeUsername(usernameInput.value.trim());
  if(!uname) return setMsg(userMsg,'Username cannot be empty.','err');
  const { data:exists }=await sb.from('profiles').select('id').ilike('username',uname).neq('id',user.id).limit(1);
  if(exists && exists.length>0) return setMsg(userMsg,'Username already taken.','err');
  const upd=await sb.from('profiles').update({username:uname}).eq('id',user.id);
  if(upd.error) return setMsg(userMsg,'Failed updating username: '+upd.error.message,'err');
  setMsg(userMsg,'Username updated!','ok');
});

// bio
saveBioBtn.addEventListener('click', async ()=>{
  const bio=bioInput.value.trim();
  const { error }=await sb.from('profiles').update({bio}).eq('id',user.id);
  if(error) return setMsg(bioMsg,'Error: '+error.message,'err');
  setMsg(bioMsg,'Bio updated!','ok');
});

// usdc
saveUsdc.addEventListener('click', async ()=>{
  const val=(usdcAddr.value||'').trim();
  if(!/^0x[a-fA-F0-9]{40}$/.test(val)) return setMsg(usdcMsg,'Invalid address.','err');
  const { error } = await sb.from('profiles').update({ usdc_base_address: val }).eq('id', user.id);
  if(error) return setMsg(usdcMsg,'Error: '+error.message,'err');
  setMsg(usdcMsg,'Saved','ok');
});

// sign out helpers
async function safeSignOut(scope){
  try{
    const { error }=await sb.auth.signOut(scope?{scope}:undefined);
    if(error && error.message!=='Auth session missing!'){ setMsg(logoutMsg,'Error: '+error.message,'err'); return false; }
    return true;
  }catch(e){ setMsg(logoutMsg,'Error: '+(e?.message||e),'err'); return false; }
}
logoutLocalBtn.addEventListener('click', async ()=>{ setMsg(logoutMsg,'Signing out…'); if(await safeSignOut(null)) location.href='index.html'; });
logoutGlobalBtn.addEventListener('click', async ()=>{ setMsg(logoutMsg,'Signing out everywhere…'); if(await safeSignOut('global')) location.href='index.html'; });
</script>
</body>
</html>
