<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Account Settings</title>
<style>
  :root{--panel:#1c1c1c;--muted:#a9adb4}
  body{margin:0;background:#111;color:#eee;font-family:Arial,Helvetica,sans-serif}
  .wrap{max-width:840px;margin:0 auto;padding:24px}
  a{color:#9ecbff;text-decoration:none}
  .card{background:var(--panel);border-radius:12px;padding:16px;margin-top:16px}
  .row{display:grid;grid-template-columns:160px 1fr;gap:16px;align-items:center}
  input,button,textarea{padding:10px;border-radius:6px;border:1px solid #333;background:#222;color:#eee}
  button{border:none;background:crimson;cursor:pointer}
  .muted{color:var(--muted)}
  .ok{color:#9f9}.err{color:#f88}
  .tools{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  /* avatar + frame */
  .avatarWrap{position:relative;width:120px;height:120px}
  .avatar{width:120px;height:120px;border-radius:50%;background:#222;overflow:hidden;display:flex;align-items:center;justify-content:center}
  .avatar img{max-width:100%;max-height:100%}
  .frameOverlay{
    position:absolute;inset:0;
    background-size:contain;background-position:center;background-repeat:no-repeat;
    pointer-events:none;transform-origin:center;
    transform:translate(var(--frameX, 0px), var(--frameY, 0px)) scale(var(--frameScale, 1));
  }
  /* cosmetics gallery */
  .hscroll{display:flex;gap:12px;overflow:auto;padding-bottom:6px}
  .frameCard{min-width:140px;background:#181818;border-radius:10px;border:1px solid #2a2a2a;padding:8px;text-align:center;cursor:pointer;position:relative}
  .frameThumb{width:100%;aspect-ratio:1/1;display:flex;align-items:center;justify-content:center;background:#0f0f0f;border-radius:8px;overflow:hidden}
  .frameThumb img{max-width:100%;max-height:100%}
  .sel{outline:2px solid #4ade80}
  .dim{opacity:.35;filter:grayscale(.9)}
  .lock{position:absolute;inset:0;background:rgba(0,0,0,.55);display:flex;align-items:center;justify-content:center;border-radius:12px;font-weight:600}
</style>
</head>
<body>
<app-menu></app-menu>
<script type="module" src="/menu.js"></script>

<div class="wrap">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <a href="index.html">← Home</a>
    <a href="portfolio.html" style="background:#444;padding:8px 12px;border-radius:6px;color:#fff;text-decoration:none">My Portfolio</a>
  </div>
  <h2>Account Settings</h2>
  <div id="roleBanner" class="muted" style="margin-top:6px"></div>
  
   <!-- USDC (Base) Wallet -->
  <div class="card">
    <h3>USDC (Base) Wallet</h3>
    <p class="muted">Enter your Base address (starts with 0x…) to receive USDC for sales. Required to sell. Only <strong>subscribers</strong> (and moderators/owner) can enable selling.</p>
    <div class="tools">
      <input id="usdcAddr" placeholder="0x..." style="min-width:320px">
      <button id="saveUsdc" style="background:#2a6">Save</button>
      <span id="usdcMsg" class="muted"></span>
    </div>
  </div>

  <!-- Avatar -->
  <div class="card">
    <h3>Profile Picture</h3>
    <div class="row">
      <div class="avatarWrap">
        <div class="avatar" id="avatarBox"><span class="muted">No image</span></div>
        <div id="frameOverlay" class="frameOverlay"></div>
      </div>
      <div class="tools">
        <input type="file" id="avatarFile" accept="image/*" />
        <button id="uploadAvatar">Upload</button>
        <span id="avatarMsg" class="muted"></span>
      </div>
    </div>
  </div>

  <!-- Username -->
  <div class="card">
    <h3>Change Username</h3>
    <div class="row">
      <label class="muted">New username</label>
      <div class="tools">
        <input id="username" placeholder="e.g., nate008"/>
        <button id="saveUsername">Save</button>
        <span id="userMsg" class="muted"></span>
      </div>
    </div>
  </div>

  <!-- Bio -->
  <div class="card">
    <h3>Bio</h3>
    <textarea id="bioInput" placeholder="Tell people about yourself…" style="width:100%;height:80px;"></textarea>
    <div class="tools" style="margin-top:8px">
      <button id="saveBio">Save Bio</button>
      <span id="bioMsg" class="muted"></span>
    </div>
  </div>

  <!-- Showcase -->
  <div class="card">
    <h3>Showcase Favorites</h3>
    <p class="muted" style="margin-top:6px">Paste up to 5 item IDs (from item URLs) separated by commas.</p>
    <div class="tools">
      <input id="showcaseInput" placeholder="65a7f..., b91c4..., ..." style="flex:1"/>
      <button id="saveShowcase">Save Showcase</button>
      <span id="showcaseMsg" class="muted"></span>
    </div>
  </div>

  <!-- Cosmetics: Frames (gallery + apply) -->
  <div class="card" style="position:relative">
    <h3 style="margin-bottom:10px">Cosmetics → Profile Picture Frames</h3>

    <div id="lock" class="lock" style="display:none">Subscribe to unlock</div>

    <div id="framesRow" class="hscroll"></div>

    <div class="tools" id="subsTools" style="display:none;margin-top:8px">
      <button id="saveFrame" style="background:#2a6">Use Selected Frame</button>
      <button id="clearFrame" style="background:#555">Remove Frame</button>
      <span id="frameMsg" class="muted"></span>
    </div>

    <!-- Owner upload tools -->
    <div id="modTools" style="display:none;margin-top:14px;border-top:1px dashed #333;padding-top:12px">
      <h4 style="margin:0 0 6px">Owner: Upload new frame</h4>
      <div class="tools">
        <input id="frameTitle" placeholder="Frame title (optional)"/>
        <input id="frameScale" type="number" step="0.01" min="0.5" max="2" value="1.08" style="width:110px" title="Scale"/>
        <input id="frameFile" type="file" accept="image/*" />
        <button id="uploadFrame">Upload Frame</button>
        <span id="uploadMsg" class="muted"></span>
      </div>
      <div class="muted" style="font-size:12px">Recommended: square PNG with transparency (e.g., 1024×1024).</div>
    </div>
  </div>

  <!-- Password -->
  <div class="card">
    <h3>Change Password (Email Confirmation)</h3>
    <p class="muted">We’ll send a secure reset link to your email.</p>
    <div class="tools">
      <button id="sendReset">Send Password Reset Email</button>
      <span id="pwdMsg" class="muted"></span>
    </div>
  </div>

  <!-- Logout -->
  <div class="card">
    <h3>Sign out</h3>
    <div class="tools">
      <button id="logoutLocal"  style="background:#666">Sign out (this device)</button>
      <button id="logoutGlobal" style="background:#c33">Sign out (all devices)</button>
      <span id="logoutMsg" class="muted"></span>
    </div>
  </div>
</div>

<!-- Frame Editor Modal -->
<div id="frameEditor" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);
     z-index:9999;align-items:center;justify-content:center">
  <div style="background:#1c1c1c;color:#eee;border-radius:12px;max-width:520px;width:90%;
              padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.5)">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 style="margin:0">Edit Frame</h3>
      <button id="feClose" style="background:#333;border:none;border-radius:6px;padding:6px 10px;cursor:pointer">Close</button>
    </div>

    <div style="display:flex;gap:16px;align-items:center;margin:12px 0">
      <div class="avatarWrap">
        <div class="avatar" id="feAva"></div>
        <div id="feOverlay" class="frameOverlay"></div>
      </div>
      <div style="flex:1">
        <div style="display:grid;grid-template-columns:80px 1fr auto;align-items:center;gap:8px">
          <label>X:</label>
          <input id="feX" type="range" min="-80" max="80" step="1">
          <span id="feXv" class="muted"></span>

          <label>Y:</label>
          <input id="feY" type="range" min="-80" max="80" step="1">
          <span id="feYv" class="muted"></span>

          <label>Scale:</label>
          <input id="feS" type="range" min="0.5" max="2" step="0.01">
          <span id="feSv" class="muted"></span>
        </div>
      </div>
    </div>

    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button id="feSave" style="background:#2a6;border:none;border-radius:6px;padding:8px 12px;cursor:pointer">
        Save
      </button>
      <button id="feSaveApply" style="background:#4a6;border:none;border-radius:6px;padding:8px 12px;cursor:pointer">
        Save & Apply
      </button>
    </div>
    <div id="feMsg" class="muted" style="margin-top:6px"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const sb = supabase.createClient(
  'https://wktxpukjmvmhzpctttjx.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndrdHhwdWtqbXZtaHpwY3R0dGp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxMjg2MjAsImV4cCI6MjA3MTcwNDYyMH0.07xzRjb_iQlkaObfslKiL9VZIHT8P3vnK-ZkIVm2qVY'
);
const AVATAR_BUCKET='avatars', FRAMES_BUCKET='frames';

const roleBanner=document.getElementById('roleBanner');
const avatarBox=document.getElementById('avatarBox');
const avatarFile=document.getElementById('avatarFile');
const uploadAvatarBtn=document.getElementById('uploadAvatar');
const avatarMsg=document.getElementById('avatarMsg');
const frameOverlay=document.getElementById('frameOverlay');

const usernameInput=document.getElementById('username');
const saveUsernameBtn=document.getElementById('saveUsername');
const userMsg=document.getElementById('userMsg');

const bioInput=document.getElementById('bioInput');
const saveBioBtn=document.getElementById('saveBio');
const bioMsg=document.getElementById('bioMsg');

const showcaseInput=document.getElementById('showcaseInput');
const saveShowcaseBtn=document.getElementById('saveShowcase');
const showcaseMsg=document.getElementById('showcaseMsg');

const pwdMsg=document.getElementById('pwdMsg');
const sendResetBtn=document.getElementById('sendReset');

const logoutMsg=document.getElementById('logoutMsg');
const logoutLocalBtn=document.getElementById('logoutLocal');
const logoutGlobalBtn=document.getElementById('logoutGlobal');

const framesRow=document.getElementById('framesRow');
const subsTools=document.getElementById('subsTools');
const modTools=document.getElementById('modTools');
const saveFrameBtn=document.getElementById('saveFrame');
const clearFrameBtn=document.getElementById('clearFrame');
const frameMsg=document.getElementById('frameMsg');
const lockOverlay=document.getElementById('lock');

const frameTitle=document.getElementById('frameTitle');
const frameScaleInput=document.getElementById('frameScale');
const frameFile=document.getElementById('frameFile');
const uploadFrameBtn=document.getElementById('uploadFrame');
const uploadMsg=document.getElementById('uploadMsg');

// USDC wallet handling (Settings)
const usdcAddr = document.getElementById('usdcAddr');
const saveUsdc = document.getElementById('saveUsdc');
const usdcMsg  = document.getElementById('usdcMsg');

function _setMsg(el,txt,cls='muted'){ if(!el) return; el.className=cls; el.textContent=txt; }

// Prefill the wallet if saved
(async function init_usdc_wallet(){
  try{
    const { data:{ session } } = await sb.auth.getSession();
    if (!session) return;
    const { data: p } = await sb.from('profiles')
      .select('usdc_base_address')
      .eq('id', session.user.id)
      .maybeSingle();
    if (p?.usdc_base_address && usdcAddr) usdcAddr.value = p.usdc_base_address;
  }catch(_e){}
})();

// Save wallet button
saveUsdc?.addEventListener('click', async ()=>{
  if (!usdcAddr) return;
  const v = (usdcAddr.value||'').trim();
  if(!/^0x[a-fA-F0-9]{40}$/.test(v)) return _setMsg(usdcMsg,'Invalid address.','err');
  const { data:{ session } } = await sb.auth.getSession();
  if (!session) return _setMsg(usdcMsg,'Please sign in.','err');
  const { error } = await sb.from('profiles')
    .update({ usdc_base_address: v })
    .eq('id', session.user.id);
  if (error) return _setMsg(usdcMsg,'Error: '+error.message,'err');
  _setMsg(usdcMsg,'Saved.','ok');
});


// --- Frame Editor refs ---
const fe = {
  root: document.getElementById('frameEditor'),
  close: document.getElementById('feClose'),
  ava: document.getElementById('feAva'),
  overlay: document.getElementById('feOverlay'),
  x: document.getElementById('feX'),
  y: document.getElementById('feY'),
  s: document.getElementById('feS'),
  xv: document.getElementById('feXv'),
  yv: document.getElementById('feYv'),
  sv: document.getElementById('feSv'),
  save: document.getElementById('feSave'),
  saveApply: document.getElementById('feSaveApply'),
  msg: document.getElementById('feMsg'),
  state: { id:null, url:'', x:0, y:0, s:1 }
};

let user=null, role='free';
let selectedFrameUrl=null, selectedFrameScale=1.0;
let currentFrameUrl=null, currentFrameScale=1.0;

const setMsg=(el,txt,cls='muted')=>{el.className=cls; el.textContent=txt;};
const sanitizeUsername=(u)=>u.toLowerCase().replace(/[^a-z0-9_.-]/g,'').slice(0,30);

(async function init(){
  const { data:{ session } } = await sb.auth.getSession();
  if(!session){ alert('Please log in first.'); location.href='login.html'; return; }
  user=session.user;

  const { data: profile } = await sb.from('profiles')
    .select('username, avatar_url, bio, showcase_ids, role, frame_url, frame_scale, frame_offset_x, frame_offset_y')
    .eq('id', user.id).maybeSingle();

  role=profile?.role||'free';
  currentFrameUrl=profile?.frame_url||null;
  currentFrameScale=profile?.frame_scale??1.0;

  if(profile?.avatar_url) avatarBox.innerHTML=`<img src="${profile.avatar_url}" alt="avatar">`;
  if(currentFrameUrl){
    frameOverlay.style.backgroundImage=`url('${currentFrameUrl}')`;
    frameOverlay.style.setProperty('--frameScale', currentFrameScale);
    frameOverlay.style.setProperty('--frameX', (profile?.frame_offset_x ?? 0) + 'px');
    frameOverlay.style.setProperty('--frameY', (profile?.frame_offset_y ?? 0) + 'px');
  }
  if(profile?.username) usernameInput.value=profile.username;
  if(profile?.bio) bioInput.value=profile.bio;
  if(profile?.showcase_ids?.length) showcaseInput.value=profile.showcase_ids.join(', ');
  roleBanner.textContent=`Your role: ${role}`;

  // Gallery gating: subscribers, moderators, owners see frames & can apply
  if(role==='free'){ lockOverlay.style.display='flex'; framesRow.classList.add('dim'); }
  else { subsTools.style.display='flex'; await loadFrames(); }

  // Upload gate: owner only
  if(role==='owner'){ modTools.style.display='block'; }
})();

async function loadFrames(){
  framesRow.innerHTML='<div class="muted">Loading frames…</div>';
  const { data: frames, error } = await sb
    .from('frames').select('id,title,image_url,scale,offset_x,offset_y,created_by,created_at').order('created_at',{ascending:false});
  if(error){ framesRow.innerHTML='<div class="muted err">Failed to load frames.</div>'; return; }
  if(!frames?.length){ framesRow.innerHTML='<div class="muted">No frames uploaded yet.</div>'; return; }

  framesRow.innerHTML = frames.map(fr=>`
    <div class="frameCard ${fr.image_url===currentFrameUrl?'sel':''}"
         data-url="${fr.image_url}" data-scale="${fr.scale??1}">
      <div class="frameThumb"><img src="${fr.image_url}" alt=""></div>
      <div class="muted" style="margin-top:6px;font-size:13px">
        ${fr.title||'Frame'} · ${Math.round((fr.scale??1)*100)}%
      </div>
      ${role==='owner' ? `
        <div style="margin-top:6px">
          <button class="editFrameBtn" data-id="${fr.id}"
                  data-url="${fr.image_url}"
                  data-scale="${fr.scale ?? 1}"
                  data-x="${fr.offset_x ?? 0}"
                  data-y="${fr.offset_y ?? 0}"
                  style="background:#444;border:none;border-radius:6px;padding:6px 10px;cursor:pointer">
            Edit
          </button>
        </div>` : ''}
    </div>
  `).join('');

  framesRow.querySelectorAll('.frameCard').forEach(card=>{
    card.addEventListener('click',()=>{
      framesRow.querySelectorAll('.frameCard').forEach(c=>c.classList.remove('sel'));
      card.classList.add('sel');
      selectedFrameUrl=card.dataset.url;
      selectedFrameScale=parseFloat(card.dataset.scale||'1');
      frameOverlay.style.backgroundImage=`url('${selectedFrameUrl}')`;
      frameOverlay.style.setProperty('--frameScale', selectedFrameScale);
      // Try to read x/y from sibling edit button if present
      const btn = card.querySelector('.editFrameBtn');
      if (btn) {
        frameOverlay.style.setProperty('--frameX', (parseFloat(btn.dataset.x||'0')) + 'px');
        frameOverlay.style.setProperty('--frameY', (parseFloat(btn.dataset.y||'0')) + 'px');
      }
    });
  });

  // Owner-only editor buttons
  framesRow.querySelectorAll('.editFrameBtn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      openFrameEditor({
        id:   btn.dataset.id,
        url:  btn.dataset.url,
        scale:parseFloat(btn.dataset.scale||'1'),
        x:    parseFloat(btn.dataset.x||'0'),
        y:    parseFloat(btn.dataset.y||'0')
      });
    });
  });
}

// avatar upload
uploadAvatarBtn.addEventListener('click', async ()=>{
  if(!avatarFile.files[0]) return setMsg(avatarMsg,'Choose an image first.','err');
  const file=avatarFile.files[0];
  const safe=file.name.replace(/[^\w.\-]+/g,'_');
  const path=`${user.id}/avatar-${Date.now()}-${safe}`;
  setMsg(avatarMsg,'Uploading…');
  const up=await sb.storage.from(AVATAR_BUCKET).upload(path,file,{upsert:true,contentType:file.type});
  if(up.error) return setMsg(avatarMsg,'Upload error: '+up.error.message,'err');
  const { data:pub }=sb.storage.from(AVATAR_BUCKET).getPublicUrl(path);
  const url=pub.publicUrl;
  const upd=await sb.from('profiles').update({avatar_url:url}).eq('id',user.id);
  if(upd.error) return setMsg(avatarMsg,'Failed saving avatar URL: '+upd.error.message,'err');
  avatarBox.innerHTML=`<img src="${url}" alt="avatar">`;
  setMsg(avatarMsg,'Avatar updated!','ok');
});

// username
saveUsernameBtn.addEventListener('click', async ()=>{
  let uname=sanitizeUsername(usernameInput.value.trim());
  if(!uname) return setMsg(userMsg,'Username cannot be empty.','err');
  const { data:exists }=await sb.from('profiles').select('id').ilike('username',uname).neq('id',user.id).limit(1);
  if(exists && exists.length>0) return setMsg(userMsg,'Username already taken.','err');
  const upd=await sb.from('profiles').update({username:uname}).eq('id',user.id);
  if(upd.error) return setMsg(userMsg,'Failed updating username: '+upd.error.message,'err');
  setMsg(userMsg,'Username updated!','ok');
});

// bio
saveBioBtn.addEventListener('click', async ()=>{
  const bio=bioInput.value.trim();
  const { error }=await sb.from('profiles').update({bio}).eq('id',user.id);
  if(error) return setMsg(bioMsg,'Error: '+error.message,'err');
  setMsg(bioMsg,'Bio updated!','ok');
});

// showcase
saveShowcaseBtn.addEventListener('click', async ()=>{
  const arr=showcaseInput.value.split(',').map(x=>x.trim()).filter(Boolean).slice(0,5);
  const { error }=await sb.from('profiles').update({showcase_ids:arr}).eq('id',user.id);
  if(error) return setMsg(showcaseMsg,'Error: '+error.message,'err');
  setMsg(showcaseMsg,'Showcase updated!','ok');
});

// password reset
sendResetBtn.addEventListener('click', async ()=>{
  setMsg(pwdMsg,'Sending reset email…');
  const redirectTo=window.location.origin+'/reset.html';
  const { error }=await sb.auth.resetPasswordForEmail(user.email,{redirectTo});
  if(error) return setMsg(pwdMsg,'Error: '+error.message,'err');
  setMsg(pwdMsg,'Check your email for the reset link.','ok');
});

// save / clear frame selection
saveFrameBtn.addEventListener('click', async ()=>{
  if(!selectedFrameUrl) return setMsg(frameMsg,'Pick a frame first.','err');
  // Try to get offsets from the selected card's edit button
  const selCard = framesRow.querySelector('.frameCard.sel');
  let offX = 0, offY = 0;
  if (selCard) {
    const btn = selCard.querySelector('.editFrameBtn');
    if (btn) { offX = parseFloat(btn.dataset.x||'0'); offY = parseFloat(btn.dataset.y||'0'); }
  }
  const { error }=await sb.from('profiles')
    .update({ frame_url:selectedFrameUrl, frame_scale:selectedFrameScale, frame_offset_x: offX, frame_offset_y: offY })
    .eq('id',user.id);
  if(error) return setMsg(frameMsg,'Error: '+error.message,'err');
  currentFrameUrl=selectedFrameUrl; currentFrameScale=selectedFrameScale;
  frameOverlay.style.setProperty('--frameX', offX + 'px');
  frameOverlay.style.setProperty('--frameY', offY + 'px');
  setMsg(frameMsg,'Frame applied!','ok');
});
clearFrameBtn.addEventListener('click', async ()=>{
  const { error }=await sb.from('profiles')
    .update({ frame_url:null, frame_scale:1.0, frame_offset_x:0, frame_offset_y:0 })
    .eq('id',user.id);
  if(error) return setMsg(frameMsg,'Error: '+error.message,'err');
  selectedFrameUrl=null; selectedFrameScale=1.0;
  currentFrameUrl=null; currentFrameScale=1.0;
  frameOverlay.style.backgroundImage='none';
  frameOverlay.style.setProperty('--frameScale',1);
  frameOverlay.style.setProperty('--frameX','0px');
  frameOverlay.style.setProperty('--frameY','0px');
  framesRow.querySelectorAll('.frameCard').forEach(c=>c.classList.remove('sel'));
  setMsg(frameMsg,'Frame removed.','ok');
});

// owner-only upload
uploadFrameBtn.addEventListener('click', async ()=>{
  const { data: me } = await sb.from('profiles').select('role').eq('id',user.id).maybeSingle();
  if(!(me?.role==='owner')) return setMsg(uploadMsg,'Only the owner can upload.','err');
  const f=frameFile.files[0]; if(!f) return setMsg(uploadMsg,'Choose a PNG with transparency.','err');
  const scaleVal=parseFloat(frameScaleInput.value||'1');
  setMsg(uploadMsg,'Uploading…');
  const safe=f.name.replace(/[^\w.\-]+/g,'_');
  const path=`${user.id}/frame-${Date.now()}-${safe}`;
  const up=await sb.storage.from(FRAMES_BUCKET).upload(path,f,{upsert:true,contentType:f.type});
  if(up.error) return setMsg(uploadMsg,'Upload error: '+up.error.message,'err');
  const { data: pub }=sb.storage.from(FRAMES_BUCKET).getPublicUrl(path);
  const url=pub.publicUrl;
  const ins=await sb.from('frames').insert({
    title:frameTitle.value.trim()||null,
    image_url:url,
    created_by:user.id,
    scale:isFinite(scaleVal)?scaleVal:1.0,
    offset_x: 0,
    offset_y: 0
  });
  if(ins.error) return setMsg(uploadMsg,'Save error: '+ins.error.message,'err');
  setMsg(uploadMsg,'Frame uploaded!','ok');
  frameTitle.value=''; frameFile.value=''; await loadFrames();
});

// --- Frame Editor logic ---
function openFrameEditor({id,url,x,y,scale}) {
  if (role !== 'owner') return; // UI gate
  fe.state = { id, url, x, y, s: scale ?? 1 };
  fe.ava.innerHTML = avatarBox.innerHTML; // show current avatar in the mini preview
  fe.overlay.style.backgroundImage = `url('${url}')`;
  fe.overlay.style.setProperty('--frameX', x + 'px');
  fe.overlay.style.setProperty('--frameY', y + 'px');
  fe.overlay.style.setProperty('--frameScale', (scale ?? 1));

  fe.x.value = x; fe.y.value = y; fe.s.value = scale ?? 1;
  fe.xv.textContent = x + 'px';
  fe.yv.textContent = y + 'px';
  fe.sv.textContent = (scale ?? 1).toFixed(2) + '×';
  fe.msg.textContent = '';

  fe.root.style.display = 'flex';
}

fe.close.addEventListener('click', ()=> fe.root.style.display = 'none');

[fe.x, fe.y, fe.s].forEach(inp=>{
  inp.addEventListener('input', ()=>{
    const x = Number(fe.x.value), y = Number(fe.y.value), s = Number(fe.s.value);
    fe.overlay.style.setProperty('--frameX', x + 'px');
    fe.overlay.style.setProperty('--frameY', y + 'px');
    fe.overlay.style.setProperty('--frameScale', s);
    fe.xv.textContent = x + 'px';
    fe.yv.textContent = y + 'px';
    fe.sv.textContent = s.toFixed(2) + '×';
    fe.state.x = x; fe.state.y = y; fe.state.s = s;
  });
});

fe.save.addEventListener('click', async ()=>{
  fe.msg.textContent = 'Saving…';
  const { error } = await sb.from('frames').update({
    offset_x: fe.state.x,
    offset_y: fe.state.y,
    scale:    fe.state.s
  }).eq('id', fe.state.id);
  fe.msg.textContent = error ? ('Error: ' + error.message) : 'Saved.';
  if (!error) { await loadFrames(); } // refresh gallery labels
});

fe.saveApply.addEventListener('click', async ()=>{
  fe.msg.textContent = 'Saving & applying…';
  const up1 = await sb.from('frames').update({
    offset_x: fe.state.x,
    offset_y: fe.state.y,
    scale:    fe.state.s
  }).eq('id', fe.state.id);

  if (up1.error) { fe.msg.textContent = 'Error: ' + up1.error.message; return; }

  await sb.from('profiles').update({
    frame_url:      fe.state.url,
    frame_scale:    fe.state.s,
    frame_offset_x: fe.state.x,
    frame_offset_y: fe.state.y
  }).eq('id', user.id);

  // update live preview
  frameOverlay.style.backgroundImage = `url('${fe.state.url}')`;
  frameOverlay.style.setProperty('--frameScale', fe.state.s);
  frameOverlay.style.setProperty('--frameX', fe.state.x + 'px');
  frameOverlay.style.setProperty('--frameY', fe.state.y + 'px');

  fe.msg.textContent = 'Saved & applied.';
  await loadFrames();
});

</script>
</body>
</html>

