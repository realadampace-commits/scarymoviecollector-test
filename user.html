<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>User — Scream Collector</title>
<style>
  :root{--bg:#111;--panel:#1b1b1b;--ink:#eee;--muted:#a9adb4;--accent:#dc143c;--ok:#2a6}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:Arial,Helvetica,sans-serif}
  a{color:#9ecbff;text-decoration:none}
  .wrap{max-width:1100px;margin:0 auto;padding:24px}
  .card{background:var(--panel);border-radius:12px;padding:16px}
  .muted{color:var(--muted)} .ok{color:#9f9}.err{color:#f88}
  .row{display:flex;gap:16px;align-items:center;flex-wrap:wrap}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px}
  .pill{display:inline-block;background:#232323;border:1px solid #333;border-radius:999px;padding:4px 10px;font-size:12px;color:#cfcfcf}
  .avatarWrap{position:relative;width:92px;height:92px}
  .avatar{width:92px;height:92px;border-radius:50%;background:#222;overflow:hidden;display:flex;align-items:center;justify-content:center}
  .avatar img{max-width:100%;max-height:100%}
  .frameOverlay{
    position:absolute;inset:0;
    background-size:contain;background-position:center;background-repeat:no-repeat;
    pointer-events:none;transform-origin:center;
    transform:translate(var(--frameX, 0px), var(--frameY, 0px)) scale(var(--frameScale, 1));
  }
  .itemCard{background:#181818;border:1px solid #2a2a2a;border-radius:12px;overflow:hidden}
  .thumb{width:100%;aspect-ratio:4/3;background:#0f0f0f;display:flex;align-items:center;justify-content:center}
  .thumb img{max-width:100%;max-height:100%;display:block}
  .itemBody{padding:10px}
  .itemTitle{margin:0 0 6px;font-size:15px;line-height:1.25}
  .row2{display:flex;justify-content:space-between;align-items:center;gap:8px}
  .price{font-weight:700}
  .soldPill{background:#2a2a2a;color:#eee;border:1px solid #3a3a3a}
  .sectionHead{display:flex;justify-content:space-between;align-items:center;margin-top:18px;margin-bottom:8px}
  .hscroll{display:flex;gap:10px;overflow:auto;padding-bottom:4px}
  .mini{min-width:160px;background:#181818;border:1px solid #2a2a2a;border-radius:10px;overflow:hidden}
  .mini .thumb{aspect-ratio:1/1}
  .mini .itemBody{padding:8px}
  .empty{padding:14px;border:1px dashed #333;border-radius:10px;color:var(--muted);text-align:center}
</style>
</head>
<body>
<app-menu></app-menu>
<script type="module" src="/menu.js"></script>

<div class="wrap">
  <a href="index.html">← Home</a>

  <!-- Profile header -->
  <div class="card" style="margin-top:12px">
    <div class="row">
      <div class="avatarWrap">
        <div id="avatarBox" class="avatar"><span class="muted">No image</span></div>
        <div id="frameOverlay" class="frameOverlay"></div>
      </div>
      <div style="flex:1;min-width:220px">
        <h1 id="uname" style="margin:0;font-size:22px">Loading…</h1>
        <div id="roleBadge" class="pill" style="margin-top:6px;display:none"></div>
      </div>
    </div>
    <div id="bio" class="muted" style="margin-top:10px">—</div>
  </div>

  <!-- Showcase (optional) -->
  <div id="showcaseWrap" class="card" style="margin-top:12px;display:none">
    <div class="sectionHead">
      <h3 style="margin:0">Showcase</h3>
    </div>
    <div id="showcaseRow" class="hscroll"></div>
  </div>

  <!-- Active Portfolio -->
  <div class="sectionHead" style="margin-top:16px">
    <h3 style="margin:0">Portfolio</h3>
    <span id="portfolioCount" class="muted"></span>
  </div>
  <div id="portfolioGrid" class="grid"></div>
  <div id="portfolioEmpty" class="empty" style="display:none">No items yet.</div>

  <!-- SOLD ITEMS (new) -->
  <div class="sectionHead" style="margin-top:20px">
    <h3 style="margin:0">Sold Items</h3>
    <span id="soldCount" class="muted"></span>
  </div>
  <div id="soldGrid" class="grid"></div>
  <div id="soldEmpty" class="empty" style="display:none">No sold items.</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const sb = supabase.createClient(
  'https://wktxpukjmvmhzpctttjx.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndrdHhwdWtqbXZtaHpwY3R0dGp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxMjg2MjAsImV4cCI6MjA3MTcwNDYyMH0.07xzRjb_iQlkaObfslKiL9VZIHT8P3vnK-ZkIVm2qVY'
);

// DOM
const unameEl = document.getElementById('uname');
const roleBadge = document.getElementById('roleBadge');
const avatarBox = document.getElementById('avatarBox');
const frameOverlay = document.getElementById('frameOverlay');
const bioEl = document.getElementById('bio');

const portfolioGrid = document.getElementById('portfolioGrid');
const portfolioCount = document.getElementById('portfolioCount');
const portfolioEmpty = document.getElementById('portfolioEmpty');

const soldGrid = document.getElementById('soldGrid');
const soldCount = document.getElementById('soldCount');
const soldEmpty = document.getElementById('soldEmpty');

const showcaseWrap = document.getElementById('showcaseWrap');
const showcaseRow = document.getElementById('showcaseRow');

// tiny debug line (optional)
const dbg = (m,o)=>{ 
  let el = document.getElementById('dbg'); 
  if(!el){ el=document.createElement('div'); el.id='dbg'; el.style.cssText='margin:6px 0;color:#9aa;font-size:12px'; unameEl.parentElement.appendChild(el); }
  el.textContent = '[debug] ' + m + (o?(' '+JSON.stringify(o)): '');
  console.log('[user.html]', m, o||'');
};

const qs = new URLSearchParams(location.search);
const rawU = decodeURIComponent((qs.get('u')||'').trim());
const username = rawU.replace(/^@/, '');

let profile = null;
let ownerId = null;

function money(n){ return '$' + Number(n||0).toLocaleString(); }

// preview helper (same logic as portfolio.html)
async function attachPreviews(items){
  if (!items?.length) return items;
  const ids = items.map(i=>i.id);
  const { data: imgs } = await sb
    .from('items_images')
    .select('item_id,image_url,position,created_at')
    .in('item_id', ids)
    .order('position',{ascending:true})
    .order('created_at',{ascending:true});
  const first = {};
  (imgs||[]).forEach(im => { if (!first[im.item_id]) first[im.item_id] = im.image_url; });
  return items.map(i => ({ ...i, preview_url: first[i.id] || null }));
}

function itemCard({id, title, price, img, forSale, soldAt, soldPrice}) {
  const soldInfo = soldAt ? `
    <span class="pill soldPill">Sold for ${money(soldPrice || 0)}</span>
  ` : (forSale ? `<span class="pill" style="border-color:#2a6;color:#9f9">For sale</span>` : '');
  return `
    <a class="itemCard" href="item.html?id=${encodeURIComponent(id)}" title="${title||'Item'}">
      <div class="thumb">${img ? `<img src="${img}" alt="">` : `<span class="muted">No image</span>`}</div>
      <div class="itemBody">
        <h4 class="itemTitle">${title || 'Untitled'}</h4>
        <div class="row2">
          <div class="price">${money(price || 0)}</div>
          ${soldInfo}
        </div>
      </div>
    </a>
  `;
}

(async function init(){
  // If ?u is missing, show MY page (like portfolio.html)
  if (!username) {
    const { data:{ session } } = await sb.auth.getSession();
    if (!session){ unameEl.textContent='User not found'; dbg('no ?u and no session'); return; }
    ownerId = session.user.id;
    const mep = await sb.from('profiles').select('id,username,role,bio,avatar_url,frame_url,frame_scale,frame_offset_x,frame_offset_y,showcase_ids').eq('id', ownerId).maybeSingle();
    if (!mep.data){ unameEl.textContent='User not found'; dbg('self profile not found'); return; }
    profile = mep.data;
  } else {
    // Public profile by username
    const pq = await sb.from('profiles')
      .select('id,username,role,bio,avatar_url,frame_url,frame_scale,frame_offset_x,frame_offset_y,showcase_ids')
      .ilike('username', username)
      .maybeSingle();
    if (!pq.data) { unameEl.textContent = 'User not found'; dbg('profile not found',{username}); return; }
    profile = pq.data;
  }

  ownerId = profile.id;
  unameEl.textContent = '@' + (profile.username || username || 'me');
  if (profile.role && profile.role !== 'free') {
    roleBadge.style.display = 'inline-block';
    roleBadge.textContent = profile.role;
  }
  bioEl.textContent = profile.bio || '—';

  if (profile.avatar_url) {
    avatarBox.innerHTML = `<img src="${profile.avatar_url}" alt="avatar">`;
  }
  if (profile.frame_url) {
    frameOverlay.style.backgroundImage = `url('${profile.frame_url}')`;
    frameOverlay.style.setProperty('--frameScale', profile.frame_scale ?? 1);
    frameOverlay.style.setProperty('--frameX', ((profile.frame_offset_x??0) + 'px'));
    frameOverlay.style.setProperty('--frameY', ((profile.frame_offset_y??0) + 'px'));
  }

  await loadAllItemsForUser();
  
  const ids = Array.isArray(profile.showcase_ids) ? profile.showcase_ids.filter(Boolean) : [];
  if (ids.length) await loadShowcase(ids);
})();

async function loadAllItemsForUser(){
  const debug = (msg, obj) => {
    let el = document.getElementById('dbg');
    if(!el){
      el = document.createElement('div');
      el.id = 'dbg';
      el.style.cssText = 'margin:6px 0;color:#9aa;font-size:12px';
      unameEl.parentElement.appendChild(el);
    }
    el.textContent = '[debug] ' + msg + (obj ? ' ' + JSON.stringify(obj) : '');
    console.log('[user.html]', msg, obj || '');
  };

  let rows = [];

  // A) Primary: by owner_id (fastest if visible)
  const qA = await sb.from('items')
    .select('id,title,user_value,created_at,owner_id,for_sale,sold_at,sold_price')
    .eq('owner_id', ownerId)
    .order('created_at', { ascending:false });
  if (qA.error) debug('A error', qA.error);
  rows = qA.data || [];
  debug('A owner_id count', { count: rows.length });

  // B) Fallback: inner join by exact username (ensures join happens)
  if (!rows.length && profile?.username) {
    const qB = await sb.from('items')
      .select('id,title,user_value,created_at,owner_id,for_sale,sold_at,sold_price,profiles!inner(username)')
      .eq('profiles.username', profile.username)
      .order('created_at', { ascending:false });
    if (qB.error) debug('B error', qB.error);
    rows = qB.data || [];
    debug('B username inner join count', { count: rows.length, username: profile.username });
  }

  // C) Fallback: case-insensitive username (ilike)
  if (!rows.length && profile?.username) {
    const qC = await sb.from('items')
      .select('id,title,user_value,created_at,owner_id,for_sale,sold_at,sold_price,profiles!inner(username)')
      .ilike('profiles.username', profile.username)
      .order('created_at', { ascending:false });
    if (qC.error) debug('C error', qC.error);
    rows = qC.data || [];
    debug('C username ilike join count', { count: rows.length, username: profile.username });
  }

  // D) Final fallback: if still nothing, render empties & stop
  if (!rows.length) {
    portfolioGrid.innerHTML = '';
    portfolioEmpty.style.display = 'block';
    soldGrid.innerHTML = '';
    soldEmpty.style.display = 'block';
    portfolioCount.textContent = '';
    soldCount.textContent = '';
    debug('No rows after all fallbacks');
    return;
  }

  // Split by sold status
  const unsold = rows.filter(r => !r.sold_at);
  const sold   = rows.filter(r => !!r.sold_at);

  // Previews (single pass)
  const withPrev = await attachPreviews(rows);
  const thumbById = new Map(withPrev.map(r => [r.id, r.preview_url || null]));

  // UNSOLD
  portfolioCount.textContent = unsold.length ? `${unsold.length} item${unsold.length>1?'s':''}` : '';
  if (!unsold.length){
    portfolioGrid.innerHTML = '';
    portfolioEmpty.style.display = 'block';
  } else {
    portfolioGrid.innerHTML = unsold.map(r => itemCard({
      id: r.id,
      title: r.title,
      price: r.user_value,
      img: thumbById.get(r.id),
      forSale: !!(r.for_sale===true||r.for_sale===1||r.for_sale==='t'||r.for_sale==='true'),
      soldAt: null,
      soldPrice: null
    })).join('');
    portfolioEmpty.style.display = 'none';
  }

  // SOLD
  soldCount.textContent = sold.length ? `${sold.length}` : '';
  if (!sold.length){
    soldGrid.innerHTML = '';
    soldEmpty.style.display = 'block';
  } else {
    soldGrid.innerHTML = sold.map(r => itemCard({
      id: r.id,
      title: r.title,
      price: r.user_value,
      img: thumbById.get(r.id),
      forSale: false,
      soldAt: r.sold_at,
      soldPrice: r.sold_price
    })).join('');
    soldEmpty.style.display = 'none';
  }

  debug('Rendered', { unsold: unsold.length, sold: sold.length });
}


// Showcase
async function loadShowcase(ids){
  try{
    const q = await sb.from('items')
      .select('id,title,user_value,for_sale,sold_at,sold_price')
      .in('id', ids.slice(0,12));
    const rows = q.data || [];
    if (!rows.length) return;

    const withPrev = await attachPreviews(rows);
    showcaseRow.innerHTML = withPrev.map(r=>{
      return `
        <a class="mini" href="item.html?id=${encodeURIComponent(r.id)}">
          <div class="thumb">${r.preview_url ? `<img src="${r.preview_url}" alt="">` : `<span class="muted">No image</span>`}</div>
          <div class="itemBody">
            <div style="display:flex;justify-content:space-between;gap:6px;align-items:center">
              <div style="font-weight:700;font-size:14px">${money(r.user_value||0)}</div>
              ${r.sold_at ? `<span class="pill soldPill" style="font-size:11px">Sold</span>` : ''}
            </div>
            <div class="muted" style="font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${r.title||'Untitled'}</div>
          </div>
        </a>
      `;
    }).join('');
    showcaseWrap.style.display = 'block';
  }catch(_e){}
}
</script>
</body>
</html>
