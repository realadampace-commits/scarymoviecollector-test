<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>User — Scream Collector</title>
<style>
  body{margin:0;background:#111;color:#eee;font-family:Arial,Helvetica,sans-serif}
  .wrap{max-width:1000px;margin:0 auto;padding:24px}
  a{color:#9ecbff;text-decoration:none}
  .muted{opacity:.75}

  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:16px;margin-top:16px}
  .card{background:#1c1c1c;border-radius:10px;overflow:hidden}
  .thumb{height:160px;background:#222;display:flex;align-items:center;justify-content:center}
  .thumb img{max-width:100%;max-height:100%}
  .meta{padding:10px}

  .userHead{display:flex;align-items:center;gap:12px}
  .ava{position:relative;width:56px;height:56px;border-radius:50%;background:#333;overflow:hidden;flex:0 0 auto}
  .ava img{width:100%;height:100%;object-fit:cover;display:block}
  .frame{position:absolute;inset:0;background-size:contain;background-position:center;background-repeat:no-repeat;pointer-events:none;transform:scale(var(--frameScale,1))}

  .roleTag{display:inline-block;margin-left:8px;padding:2px 8px;border-radius:999px;font-size:12px;vertical-align:middle}
  .role-free{background:#333;color:#ddd}
  .role-subscriber{background:#2a6;color:#fff}
  .role-moderator{background:#c33;color:#fff}

  .sectionHead{display:flex;align-items:center;justify-content:space-between;margin-top:20px}
  .btn{background:#444;color:#fff;border:none;border-radius:8px;padding:8px 12px;cursor:pointer;text-decoration:none}
</style>
</head>
<body>
<!-- Shared menu -->
<app-menu></app-menu>
<script type="module" src="/menu.js"></script>

<div class="wrap">
  <a href="users.html">← Back to Search</a>

  <div class="userHead" style="margin-top:10px">
    <span class="ava" id="uAva">
      <img id="uAvaImg" alt="">
      <span id="uAvaFrame" class="frame" style="display:none"></span>
    </span>
    <div>
      <h2 id="title" style="margin:0">Loading…</h2>
      <div id="roleTagWrap" style="margin:4px 0 0"></div>
      <p id="bio" class="muted" style="margin:4px 0 0"></p>
    </div>
  </div>

  <!-- Showcase -->
  <div id="showcase"></div>

  <!-- Portfolio -->
  <div class="sectionHead">
    <h3 style="margin:0" id="portfolioHeading">Recent Uploads</h3>
    <a id="portfolioToggle" class="btn" href="#">View full portfolio</a>
  </div>
  <div id="items" class="grid"></div>
  <div id="empty" class="muted" style="margin-top:12px; display:none">No items yet.</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const sb = supabase.createClient(
  'https://wktxpukjmvmhzpctttjx.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndrdHhwdWtqbXZtaHpwY3R0dGp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxMjg2MjAsImV4cCI6MjA3MTcwNDYyMH0.07xzRjb_iQlkaObfslKiL9VZIHT8P3vnK-ZkIVm2qVY'
);

// helper: load first photo as preview_url for each item
async function attachPreviews(items){
  if (!items?.length) return items;
  const ids = items.map(i=>i.id);
  const { data: imgs } = await sb.from('items_images')
    .select('item_id,image_url,position,created_at')
    .in('item_id', ids)
    .order('position',{ascending:true})
    .order('created_at',{ascending:true});
  const first={}; (imgs||[]).forEach(im=>{ if(!first[im.item_id]) first[im.item_id]=im.image_url; });
  return items.map(i=>({ ...i, preview_url:first[i.id]||null }));
}

const qs = new URLSearchParams(location.search);
const uname = qs.get('u');
const showAll = qs.get('all') === '1';

const itemsEl = document.getElementById('items');
const emptyEl = document.getElementById('empty');
const showcaseEl = document.getElementById('showcase');
const titleEl = document.getElementById('title');
const bioEl = document.getElementById('bio');
const roleTagWrap = document.getElementById('roleTagWrap');
const uAvaImg = document.getElementById('uAvaImg');
const uAvaFrame = document.getElementById('uAvaFrame');
const portfolioToggle = document.getElementById('portfolioToggle');
const portfolioHeading = document.getElementById('portfolioHeading');

(async function loadProfile(){
  if (!uname){ titleEl.textContent = 'User not found'; return; }

  // include frame fields
  const { data: profile, error: pErr } = await sb
    .from('profiles')
    .select('id, username, avatar_url, bio, showcase_ids, role, frame_url, frame_scale')
    .eq('username', uname)
    .maybeSingle();

  if (pErr || !profile){ titleEl.textContent = 'User not found'; return; }

  titleEl.textContent = '@' + profile.username;
  bioEl.textContent = profile.bio || '';
  if (profile.avatar_url) uAvaImg.src = profile.avatar_url;

  // role badge
  const role = profile.role || 'free';
  const roleClass = role === 'moderator' ? 'role-moderator' : role === 'subscriber' ? 'role-subscriber' : 'role-free';
  roleTagWrap.innerHTML = `<span class="roleTag ${roleClass}">${role}</span>`;

  // frame overlay
  if (profile.frame_url) {
    uAvaFrame.style.backgroundImage = `url('${profile.frame_url}')`;
    uAvaFrame.style.setProperty('--frameScale', profile.frame_scale ?? 1);
    uAvaFrame.style.display = 'block';
  } else {
    uAvaFrame.style.display = 'none';
  }

  // toggle link (?all=1)
  portfolioHeading.textContent = showAll ? 'All Items' : 'Recent Uploads';
  portfolioToggle.textContent = showAll ? 'Show last 5' : 'View full portfolio';
  const newQs = new URLSearchParams(qs);
  if (showAll) { newQs.delete('all'); } else { newQs.set('all','1'); }
  portfolioToggle.href = 'user.html?' + newQs.toString();

  // Showcase (if any)
  if (profile.showcase_ids && profile.showcase_ids.length) {
    const { data: showcaseItems } = await sb
      .from('items')
      .select('id,title,user_value')
      .in('id', profile.showcase_ids)
      .limit(5);

    const withPrev = await attachPreviews(showcaseItems||[]);
    if (withPrev.length) {
      showcaseEl.innerHTML = `
        <h3 style="margin-top:20px;margin-bottom:0">Showcase</h3>
        <div class="grid" style="margin-top:12px">
          ${withPrev.map(it=>`
            <a class="card" href="item.html?id=${it.id}" style="color:inherit;text-decoration:none">
              <div class="thumb">${it.preview_url ? `<img src="${it.preview_url}" alt="">` : 'No image'}</div>
              <div class="meta"><strong>${it.title}</strong><br>$${(it.user_value||0).toLocaleString()}</div>
            </a>
          `).join('')}
        </div>`;
    }
  }

  // Portfolio items
  await loadPortfolioItems(profile.id, showAll);
})();

async function loadPortfolioItems(ownerId, all) {
  const q = sb.from('items')
    .select('id,title,user_value,created_at')
    .eq('owner_id', ownerId)
    .order('created_at', { ascending:false });

  if (!all) q.limit(5);

  const { data: items, error } = await q;
  if (error) {
    console.error('Items load error:', error);
    itemsEl.innerHTML = '<div class="muted">Error loading items.</div>';
    return;
  }

  if (!items || items.length === 0) {
    emptyEl.style.display = 'block';
    itemsEl.innerHTML = '';
    return;
  }

  const withPrev = await attachPreviews(items);
  emptyEl.style.display = 'none';
  itemsEl.innerHTML = withPrev.map(it => `
    <a class="card" href="item.html?id=${it.id}" style="color:inherit;text-decoration:none">
      <div class="thumb">${it.preview_url ? `<img src="${it.preview_url}" alt="">` : 'No image'}</div>
      <div class="meta">
        <strong>${it.title}</strong><br>$${(it.user_value||0).toLocaleString()}
      </div>
    </a>
  `).join('');
}
</script>
</body>
</html>
