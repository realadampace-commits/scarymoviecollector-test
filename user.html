<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>User — Scream Collector</title>
<style>
  body{margin:0;background:#111;color:#eee;font-family:Arial,Helvetica,sans-serif}
  .wrap{max-width:1000px;margin:0 auto;padding:24px}
  a{color:#9ecbff;text-decoration:none}
  .muted{opacity:.75}

  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:16px;margin-top:16px}
  .card{background:#1c1c1c;border-radius:10px;overflow:hidden}
  .thumb{height:160px;background:#222;display:flex;align-items:center;justify-content:center}
  .thumb img{max-width:100%;max-height:100%}
  .meta{padding:10px}

  .userHead{display:flex;align-items:center;gap:12px}
  .ava{position:relative;width:56px;height:56px;border-radius:50%;background:#333;overflow:hidden;flex:0 0 auto}
  .ava img{width:100%;height:100%;object-fit:cover;display:block}
  .frame{position:absolute;inset:0;background-size:contain;background-position:center;background-repeat:no-repeat;pointer-events:none;transform: translate(var(--frameX, 0px), var(--frameY, 0px)) scale(var(--frameScale, 1));}

  .roleTag{display:inline-block;margin-left:8px;padding:2px 8px;border-radius:999px;font-size:12px;vertical-align:middle}
  .role-free{background:#333;color:#ddd}
  .role-subscriber{background:#2a6;color:#fff}
  .role-moderator{background:#c33;color:#fff}
  .role-owner{background:gold;color:#111;font-weight:700}

  .sectionHead{display:flex;align-items:center;justify-content:space-between;margin-top:20px}
  .btn{background:#444;color:#fff;border:none;border-radius:8px;padding:8px 12px;cursor:pointer;text-decoration:none}
  .panel{margin-top:12px;background:#1b1b1b;padding:12px;border-radius:10px}
</style>
</head>
<body>
<app-menu></app-menu>
<script type="module" src="/menu.js"></script>

<div class="wrap">
  <a href="users.html">← Back to Search</a>

  <div class="userHead" style="margin-top:10px">
    <span class="ava" id="uAva">
      <img id="uAvaImg" alt="">
      <span id="uAvaFrame" class="frame" style="display:none"></span>
    </span>
    <div>
      <h2 id="title" style="margin:0">Loading…</h2>
      <div id="roleTagWrap" style="margin:4px 0 0"></div>
      <p id="bio" class="muted" style="margin:4px 0 0"></p>
    </div>
  </div>

  <div id="rolePanel" class="panel" style="display:none"></div>

  <div id="showcase"></div>

  <div class="sectionHead">
    <h3 style="margin:0" id="portfolioHeading">Recent Uploads</h3>
    <a id="portfolioToggle" class="btn" href="#">View full portfolio</a>
  </div>
  <div id="items" class="grid"></div>
  <div id="empty" class="muted" style="margin-top:12px; display:none">No items yet.</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const sb = supabase.createClient(
  'https://wktxpukjmvmhzpctttjx.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndrdHhwdWtqbXZtaHpwY3R0dGp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxMjg2MjAsImV4cCI6MjA3MTcwNDYyMH0.07xzRjb_iQlkaObfslKiL9VZIHT8P3vnK-ZkIVm2qVY'
);

const qs = new URLSearchParams(location.search);
const uname = qs.get('u');
const showAll = qs.get('all') === '1';
const itemsEl = document.getElementById('items');
const emptyEl = document.getElementById('empty');
const showcaseEl = document.getElementById('showcase');
const titleEl = document.getElementById('title');
const bioEl = document.getElementById('bio');
const roleTagWrap = document.getElementById('roleTagWrap');
const uAvaImg = document.getElementById('uAvaImg');
const uAvaFrame = document.getElementById('uAvaFrame');
const portfolioToggle = document.getElementById('portfolioToggle');
const portfolioHeading = document.getElementById('portfolioHeading');
const rolePanel = document.getElementById('rolePanel');

let me=null, myRole='free', targetProfile=null;

(async function init(){
  if (!uname){ titleEl.textContent = 'User not found'; return; }

  const { data:{ session } } = await sb.auth.getSession();
  me = session?.user || null;
  if (me){
    const { data:p } = await sb.from('profiles').select('role').eq('id',me.id).maybeSingle();
    myRole = p?.role || 'free';
  }

  const { data: profile, error } = await sb
    .from('profiles')
    .select('id, username, avatar_url, bio, showcase_ids, role, frame_url, frame_scale, frame_offset_x, frame_offset_y')
    .eq('username', uname)
    .maybeSingle();
  if (error || !profile){ titleEl.textContent = 'User not found'; return; }
  targetProfile = profile;

  titleEl.textContent = '@' + profile.username;
  bioEl.textContent = profile.bio || '';
  if (profile.avatar_url) uAvaImg.src = profile.avatar_url;

  const role = profile.role || 'free';
  const roleClass = {
    free:'role-free', subscriber:'role-subscriber',
    moderator:'role-moderator', owner:'role-owner'
  }[role] || 'role-free';
  roleTagWrap.innerHTML = `<span class="roleTag ${roleClass}">${role}</span>`;

  if (profile.frame_url) {
    uAvaFrame.style.backgroundImage = `url('${profile.frame_url}')`;
    uAvaFrame.style.setProperty('--frameScale', profile.frame_scale ?? 1);
    uAvaFrame.style.setProperty('--frameX', (profile.frame_offset_x ?? 0) + 'px');
    uAvaFrame.style.setProperty('--frameY', (profile.frame_offset_y ?? 0) + 'px');
    uAvaFrame.style.display = 'block';
  } else {
    uAvaFrame.style.display = 'none';
  }

  if (me && myRole !== 'free' && me.id !== profile.id){
    await setupRolePanel(role);
  }

  portfolioHeading.textContent = showAll ? 'All Items' : 'Recent Uploads';
  portfolioToggle.textContent = showAll ? 'Show last 5' : 'View full portfolio';
  const newQs = new URLSearchParams(qs);
  if (showAll) newQs.delete('all'); else newQs.set('all','1');
  portfolioToggle.href = `portfolio.html?u=${encodeURIComponent(profile.username)}`;

  await loadPortfolioItems(profile.id, showAll);
})();

async function setupRolePanel(currentRole){
  let html = '';
  if (myRole === 'owner'){
    html += `<strong>Owner Controls:</strong><br>
    <label>Change Role:</label>
    <select id="roleSelect">
      <option value="free"${currentRole==='free'?' selected':''}>Free</option>
      <option value="subscriber"${currentRole==='subscriber'?' selected':''}>Subscriber</option>
      <option value="moderator"${currentRole==='moderator'?' selected':''}>Moderator</option>
    </select>
    <button id="saveRole" class="btn">Save</button>
    <span id="roleMsg" class="muted"></span>`;
  } else if (myRole === 'moderator'){
    if (currentRole === 'moderator' || currentRole === 'owner'){
      html = `<span class="muted">You cannot modify this user’s rank.</span>`;
    } else {
      html = `<strong>Moderator Controls:</strong><br>
      <label>Change Role:</label>
      <select id="roleSelect">
        <option value="free"${currentRole==='free'?' selected':''}>Free</option>
        <option value="subscriber"${currentRole==='subscriber'?' selected':''}>Subscriber</option>
      </select>
      <button id="saveRole" class="btn">Save</button>
      <span id="roleMsg" class="muted"></span>`;
    }
  }
  rolePanel.innerHTML = html;
  rolePanel.style.display = html ? 'block' : 'none';

  const saveBtn = document.getElementById('saveRole');
  if (saveBtn){
    saveBtn.onclick = async ()=>{
      const newRole = document.getElementById('roleSelect').value;
      const msgEl = document.getElementById('roleMsg');
      msgEl.textContent = 'Saving…';
      const { error } = await sb.from('profiles').update({ role:newRole }).eq('id', targetProfile.id);
      msgEl.textContent = error ? 'Error: '+error.message : 'Role updated.';
      if (!error) location.reload();
    };
  }
}

async function attachPreviews(items){
  if (!items?.length) return items;
  const ids = items.map(i=>i.id);
  const { data: imgs, error } = await sb
    .from('items_images')
    .select('item_id,image_url,position,created_at')
    .in('item_id', ids)
    .order('position',{ascending:true})
    .order('created_at',{ascending:true});
  if (error) { console.warn('preview query error:', error); return items; }
  const first = {};
  (imgs||[]).forEach(im => { if (!first[im.item_id]) first[im.item_id] = im.image_url; });
  return items.map(i => ({ ...i, preview_url: first[i.id] || null }));
}

async function loadPortfolioItems(ownerId, all) {
  const q = sb.from('items')
    .select('id,title,user_value,created_at')
    .eq('owner_id', ownerId)
    .order('created_at', { ascending:false });
  if (!all) q.limit(5);
  const { data: items, error } = await q;
    if (error) return console.error('Load error:', error);
    if (!items || !items.length){ emptyEl.style.display='block'; itemsEl.innerHTML=''; return; }
    const withPrev = await attachPreviews(items);
    emptyEl.style.display='none';
    itemsEl.innerHTML = withPrev.map(it=>`
    <a class="card" href="item.html?id=${it.id}" style="color:inherit;text-decoration:none">
    <div class="thumb">${it.preview_url ? `<img src="${it.preview_url}" alt="">` : 'No image'}</div>
    <div class="meta"><strong>${it.title}</strong><br>$${(it.user_value||0).toLocaleString()}</div>
    </a>`).join('');
}
</script>
</body>
</html>
