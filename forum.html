<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Forum — Scream Collector</title>
<style>
  :root{--bg:#111;--panel:#1b1b1b;--ink:#eee;--muted:#a9adb4}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:Arial,Helvetica,sans-serif}
  a{color:#9ecbff;text-decoration:none}
  .wrap{max-width:1000px;margin:0 auto;padding:24px}
  .card{background:var(--panel);border-radius:12px;padding:16px;margin-top:16px}
  .muted{color:var(--muted)} .ok{color:#9f9}.err{color:#f88}
  .list{list-style:none;margin:0;padding:0}
  .row{display:flex;align-items:center;justify-content:space-between;gap:10px}
  .node{padding:12px;border:1px solid #2a2a2a;background:#161616;border-radius:10px;margin-bottom:10px}
  .btn{background:#444;color:#fff;border:none;border-radius:8px;padding:6px 10px;cursor:pointer;text-decoration:none}
  input{padding:8px;border-radius:6px;border:1px solid #333;background:#222;color:#eee}
  .topbar{display:flex;align-items:center;justify-content:space-between}
</style>
</head>
<body>
<app-menu></app-menu>
<script type="module" src="/menu.js"></script>

<div class="wrap">
  <div class="topbar">
    <a href="index.html">← Home</a>
    <a href="forum.html">Forum</a>
  </div>
  <h2 style="margin-top:8px">Forum</h2>

  <!-- Moderator/Owner: create a top-level category -->
  <div id="modTop" class="card" style="display:none">
    <h3 style="margin:0 0 8px">Moderator Tools: New Category</h3>
    <div class="row">
      <input id="catTitle" placeholder="Category title (e.g., Horror Movies)"/>
      <button id="addCat" class="btn" style="background:#2a6">Create</button>
      <span id="modMsg" class="muted"></span>
    </div>
  </div>

  <div class="card">
    <div id="status" class="muted">Loading categories…</div>
    <ul id="list" class="list"></ul>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
(function(){
  const sb = supabase.createClient(
    'https://wktxpukjmvmhzpctttjx.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndrdHhwdWtqbXZtaHpwY3R0dGp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxMjg2MjAsImV4cCI6MjA3MTcwNDYyMH0.07xzRjb_iQlkaObfslKiL9VZIHT8P3vnK-ZkIVm2qVY'
  );

  const listEl   = document.getElementById('list');
  const statusEl = document.getElementById('status');
  const modTop   = document.getElementById('modTop');
  const catTitle = document.getElementById('catTitle');
  const addCat   = document.getElementById('addCat');
  const modMsg   = document.getElementById('modMsg');

  let myRole='free';

  const setStatus=(t,cls='muted')=>{statusEl.className=cls;statusEl.textContent=t;};
  const setModMsg=(t,cls='muted')=>{modMsg.className=cls;modMsg.textContent=t;};

  (async function init(){
    const { data:{ session } } = await sb.auth.getSession();
    if (session){
      const { data:p } = await sb.from('profiles').select('role').eq('id',session.user.id).maybeSingle();
      myRole = p?.role || 'free';
    }
    const isModOrOwner = (myRole==='moderator' || myRole==='owner'); // CHANGED
    if (isModOrOwner) modTop.style.display='block'; // CHANGED
    await loadTopLevel(isModOrOwner);
  })();

  async function loadTopLevel(isModOrOwner){
    setStatus('Loading categories…');
    const { data: cats, error } = await sb
      .from('forum_categories')
      .select('id,title,created_at')
      .is('parent_id', null)
      .order('title',{ascending:true});
    if (error){ setStatus('Error: '+error.message,'err'); listEl.innerHTML=''; return; }
    setStatus(cats?.length ? '' : 'No categories yet.');
    listEl.innerHTML = (cats||[]).map(c=>`
      <li class="node">
        <div class="row">
          <strong>${escapeHtml(c.title)}</strong>
          <div class="row">
            <a class="btn" href="forum_category.html?id=${c.id}">Open</a>
            ${isModOrOwner
              ? `<button class="btn" data-act="addSub" data-id="${c.id}">Add Sub</button>
                 <button class="btn" style="background:#933" data-act="delCat" data-id="${c.id}">Delete</button>`
              : ''
            }
          </div>
        </div>
      </li>
    `).join('');
  }

  function escapeHtml(s){return String(s||'').replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));}

  addCat?.addEventListener('click', async ()=>{
    const title=(catTitle.value||'').trim();
    if(!title) return setModMsg('Title required.','err');
    setModMsg('Creating…');
    const { error } = await sb.from('forum_categories').insert({ title, parent_id: null });
    if (error) return setModMsg('Error: '+error.message,'err');
    setModMsg('Created!','ok'); catTitle.value='';
    const isModOrOwner = (myRole==='moderator' || myRole==='owner');
    await loadTopLevel(isModOrOwner);
  });

  listEl.addEventListener('click', async (e)=>{
    const btn = e.target.closest('button[data-act]');
    if(!btn) return;
    const act = btn.dataset.act, id = btn.dataset.id;
    if (act==='addSub'){
      const title = prompt('Subcategory title?'); if(!title) return;
      const { error } = await sb.from('forum_categories').insert({ title, parent_id:id });
      if (error) return alert('Error: '+error.message);
      const isModOrOwner = (myRole==='moderator' || myRole==='owner');
      await loadTopLevel(isModOrOwner);
    } else if (act==='delCat'){
      if(!confirm('Delete this category (and any subcategories)?')) return;
      const { error } = await sb.from('forum_categories').delete().eq('id', id);
      if (error) return alert('Error: '+error.message);
      const isModOrOwner = (myRole==='moderator' || myRole==='owner');
      await loadTopLevel(isModOrOwner);
    }
  });
})();
</script>
</body>
</html>
