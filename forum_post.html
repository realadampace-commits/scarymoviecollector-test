<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Post — Scream Collector</title>
<style>
  :root{--bg:#111;--panel:#1b1b1b;--ink:#eee;--muted:#a9adb4;--accent:#2a6;--danger:#933}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:Arial,Helvetica,sans-serif}
  a{color:#9ecbff;text-decoration:none}
  .wrap{max-width:900px;margin:0 auto;padding:24px}

  .card{background:var(--panel);border-radius:12px;padding:16px;margin-top:16px}
  .muted{color:var(--muted)} .ok{color:#9f9}.err{color:#f88}
  .btn{background:#444;color:#fff;border:none;border-radius:8px;padding:8px 12px;cursor:pointer;text-decoration:none}
  .btn.primary{background:var(--accent)}
  .btn.danger{background:var(--danger)}

  .header{display:flex;align-items:center;gap:12px}
  .ava{position:relative;width:48px;height:48px;border-radius:50%;background:#333;overflow:hidden;flex:0 0 auto}
  .ava img{width:100%;height:100%;object-fit:cover;display:block}
  .frame{position:absolute;inset:0;background-size:contain;background-position:center;background-repeat:no-repeat;pointer-events:none;transform: translate(var(--frameX, 0px), var(--frameY, 0px)) scale(var(--frameScale, 1))

  .title{font-size:22px;margin:0}
  .meta{font-size:13px;opacity:.75}
  .body{white-space:pre-wrap;margin-top:10px}

  .replyBox{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:start}
  textarea{width:100%;min-height:100px;padding:10px;border-radius:8px;border:1px solid #333;background:#222;color:#eee}
  input,textarea{font-family:inherit}

  .reply{display:flex;gap:10px;border:1px solid #2a2a2a;background:#161616;border-radius:12px;padding:12px}
  .reply .metaRow{display:flex;align-items:center;gap:8px}
  .reply .rbody{white-space:pre-wrap;margin-top:6px}
  .row{display:flex;align-items:center;gap:10px;justify-content:space-between}
</style>
</head>
<body>
<app-menu></app-menu>
<script type="module" src="/menu.js"></script>

<div class="wrap">
  <a href="forum.html">← Forum</a>

  <!-- Post -->
  <div id="postCard" class="card">
    <div class="header">
      <span class="ava">
        <img id="pAvaImg" alt="">
        <span id="pAvaFrame" class="frame" style="display:none"></span>
      </span>
      <div>
        <h2 id="pTitle" class="title">Loading…</h2>
        <div class="meta" id="pMeta">@user • <span id="pWhen">…</span></div>
      </div>
      <div style="margin-left:auto" id="postActions"></div>
    </div>
    <div id="pBody" class="body muted" style="margin-top:8px">…</div>
  </div>

  <!-- Reply composer (any signed-in user can reply) -->
  <div id="replyCompose" class="card" style="display:none">
    <div class="row">
      <h3 style="margin:0">Reply</h3>
      <span id="rcMsg" class="muted"></span>
    </div>
    <div class="replyBox" style="margin-top:10px">
      <textarea id="rcText" placeholder="Write your reply…"></textarea>
      <button id="rcSend" class="btn primary">Post Reply</button>
    </div>
  </div>

  <!-- Replies -->
  <div class="card">
    <h3 style="margin:0 0 8px">Replies</h3>
    <div id="rStatus" class="muted">Loading…</div>
    <div id="rList" style="display:grid;gap:10px;margin-top:8px"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
(function(){
  const sb = supabase.createClient(
    'https://wktxpukjmvmhzpctttjx.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndrdHhwdWtqbXZtaHpwY3R0dGp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxMjg2MjAsImV4cCI6MjA3MTcwNDYyMH0.07xzRjb_iQlkaObfslKiL9VZIHT8P3vnK-ZkIVm2qVY'
  );

  const qs = new URLSearchParams(location.search);
  const postId = qs.get('id');

  const pTitle = document.getElementById('pTitle');
  const pBody  = document.getElementById('pBody');
  const pMeta  = document.getElementById('pMeta');
  const pWhen  = document.getElementById('pWhen');
  const pAvaImg   = document.getElementById('pAvaImg');
  const pAvaFrame = document.getElementById('pAvaFrame');
  const postActions = document.getElementById('postActions');

  const replyCompose = document.getElementById('replyCompose');
  const rcText = document.getElementById('rcText');
  const rcSend = document.getElementById('rcSend');
  const rcMsg  = document.getElementById('rcMsg');

  const rStatus = document.getElementById('rStatus');
  const rList   = document.getElementById('rList');

  let me=null, myRole='free', post=null, postAuthor=null;

  const setRcMsg = (t,cls='muted')=>{rcMsg.className=cls;rcMsg.textContent=t;};
  const setRStatus=(t,cls='muted')=>{rStatus.className=cls;rStatus.textContent=t;};
  const esc = s => String(s||'').replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));

  (async function init(){
    if (!postId){ location.href='forum.html'; return; }

    const { data:{ session } } = await sb.auth.getSession();
    me = session?.user || null;
    if (me){
      const { data:p } = await sb.from('profiles').select('role').eq('id', me.id).maybeSingle();
      myRole = p?.role || 'free';
    }
    // All ranks can reply, so just show composer when signed in
    if (me) replyCompose.style.display = 'block';

    await loadPost();
    await loadReplies();
  })();

  async function loadPost(){
    // post (no joins)
    const { data: p, error } = await sb
      .from('forum_posts')
      .select('id,title,body,created_at,author_id,category_id')
      .eq('id', postId)
      .maybeSingle();
    if (error || !p){ pTitle.textContent='Post not found'; pBody.textContent=''; return; }
    post = p;

    // author
    if (p.author_id){
      const { data: a } = await sb
        .from('profiles')
        .select('id,username,avatar_url,frame_url,frame_scale,frame_offset_x,frame_offset_y')
        .eq('id', p.author_id)
        .maybeSingle();
      postAuthor = a || null;
    }

    // render
    pTitle.textContent = p.title || '(untitled)';
    pBody.textContent  = p.body || '';
    pWhen.textContent  = new Date(p.created_at).toLocaleString();

    let by = '@user';
    if (postAuthor?.username) {
      by = `<a href="user.html?u=${encodeURIComponent(postAuthor.username)}">@${postAuthor.username}</a>`;
    }
    pMeta.innerHTML = `${by} • <span>${pWhen.textContent}</span>`;

    if (postAuthor?.avatar_url) pAvaImg.src = postAuthor.avatar_url;
    if (postAuthor?.frame_url){
      pAvaFrame.style.backgroundImage = `url('${postAuthor.frame_url}')`;
      pAvaFrame.style.setProperty('--frameScale', postAuthor.frame_scale ?? 1);
      pAvaFrame.style.setProperty('--frameX', (postAuthor.frame_offset_x ?? 0) + 'px');
      pAvaFrame.style.setProperty('--frameY', (postAuthor.frame_offset_y ?? 0) + 'px');
      pAvaFrame.style.display='block';
    } else {
      pAvaFrame.style.display='none';
    }

    // moderator actions on the post
    postActions.innerHTML = '';
    if (myRole==='moderator'){
      const delBtn = document.createElement('button');
      delBtn.className='btn danger';
      delBtn.textContent='Delete Post';
      delBtn.onclick = async ()=>{
        if (!confirm('Delete this post and all its replies?')) return;
        const del = await sb.from('forum_posts').delete().eq('id', postId);
        if (del.error) return alert('Error: '+del.error.message);
        location.href = 'forum.html';
      };
      postActions.appendChild(delBtn);
    }
  }

  async function loadReplies(){
    setRStatus('Loading…');

    const { data: reps, error } = await sb
      .from('forum_replies')
      .select('id,body,created_at,author_id')
      .eq('post_id', postId)
      .order('created_at',{ascending:true});
    if (error){ return setRStatus('Error: '+error.message, 'err'); }

    if (!reps?.length){ setRStatus('No replies yet.'); rList.innerHTML=''; return; }

    // author profiles for replies
    const ids = [...new Set(reps.map(r=>r.author_id).filter(Boolean))];
    let authors = {};
    if (ids.length){
      const { data: profs } = await sb
        .from('profiles')
        .select('id,username,avatar_url,frame_url,frame_scale')
        .in('id', ids);
      if (profs) authors = Object.fromEntries(profs.map(p=>[p.id,p]));
    }

    setRStatus('');
    rList.innerHTML = reps.map(r=>{
      const a = authors[r.author_id];
      const name = a?.username ? `@${a.username}` : 'user';
      const profileLink = a?.username ? `user.html?u=${encodeURIComponent(a.username)}` : '#';
      const when = new Date(r.created_at).toLocaleString();
      const canDelete = myRole==='moderator';

      return `
        <div class="reply" data-id="${r.id}">
          <div class="ava">
            <img src="${a?.avatar_url || ''}" alt="">
            ${a?.frame_url ? `<span class="frame" style="background-image:url('${a.frame_url}'); --frameScale:${a.frame_scale??1}"></span>` : ''}
          </div>
          <div style="flex:1">
            <div class="metaRow">
              <a href="${profileLink}">${name}</a>
              <span class="muted">• ${when}</span>
              ${canDelete ? `<button class="btn danger" style="margin-left:auto" data-del="${r.id}">Delete</button>` : ''}
            </div>
            <div class="rbody">${esc(r.body)}</div>
          </div>
        </div>
      `;
    }).join('');

    // delete handlers
    if (myRole==='moderator'){
      rList.querySelectorAll('button[data-del]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const id = btn.dataset.del;
          if (!confirm('Delete this reply?')) return;
          const { error } = await sb.from('forum_replies').delete().eq('id', id);
          if (error) return alert('Error: '+error.message);
          await loadReplies();
        });
      });
    }
  }

  // create reply
  rcSend.addEventListener('click', async ()=>{
    const text = (rcText.value||'').trim();
    if (!me) return setRcMsg('Please sign in first.','err');
    if (!text) return setRcMsg('Write something first.','err');

    setRcMsg('Posting…');
    const { error } = await sb.from('forum_replies').insert({
      post_id: postId,
      author_id: me.id,
      body: text
    });
    if (error) return setRcMsg('Error: '+error.message,'err');

    rcText.value = '';
    setRcMsg('Posted!','ok');
    await loadReplies();
  });

})();
</script>
</body>
</html>
