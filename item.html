<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Item — Scream Collector</title>
<style>
  :root{--bg:#111;--panel:#1b1b1b;--ink:#eee;--muted:#a9adb4;--accent:#dc143c;--ok:#2a6}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:Arial,Helvetica,sans-serif}
  a{color:#9ecbff;text-decoration:none}
  .wrap{max-width:1100px;margin:0 auto;padding:24px}
  .grid{display:grid;grid-template-columns:1fr 360px;gap:20px}
  .card{background:var(--panel);border-radius:12px;padding:16px}
  .muted{color:var(--muted)} .ok{color:#9f9}.err{color:#f88}
  .title{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .btn{background:#444;color:#fff;border:none;border-radius:8px;padding:8px 12px;cursor:pointer;text-decoration:none}
  .btn.main{background:var(--accent)}
  .btn.ok{background:var(--ok)}
  .stack{display:grid;gap:12px}
  .mainImg{background:#171717;border-radius:12px;display:flex;align-items:center;justify-content:center;min-height:320px;overflow:hidden;cursor:pointer}
  .mainImg img{max-width:100%;max-height:520px;display:block}
  .thumbs{display:flex;gap:10px;flex-wrap:wrap}
  .thumbs img{width:90px;height:90px;object-fit:cover;border-radius:8px;border:2px solid transparent;cursor:pointer}
  .thumbs img.sel{border-color:#4ade80}
  .overlay{position:fixed;inset:0;display:none;background:rgba(0,0,0,.85);z-index:999}
  .lightbox{position:absolute;inset:0;display:flex;align-items:center;justify-content:center}
  .lightbox img{max-width:92vw;max-height:92vh;border-radius:8px}
  .navBtn{position:absolute;top:50%;transform:translateY(-50%);font-size:28px;background:#222;border:1px solid #333;border-radius:999px;padding:8px 12px;cursor:pointer;color:#eee;opacity:.9}
  .navBtn:hover{opacity:1}
  .navPrev{left:24px} .navNext{right:24px}
  .navClose{position:absolute;top:18px;right:18px;padding:8px 10px}
</style>
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
</head>
<body>
<app-menu></app-menu>
<script type="module" src="/menu.js"></script>

<div class="wrap">
  <a href="index.html">← Back</a>

  <div class="title" style="margin-top:8px">
    <h1 id="itemTitle" style="margin:0">Loading…</h1>
    <div class="ownerTools" id="ownerTools" style="display:none">
      <a class="btn" id="editBtn">Edit</a>
      <button class="btn" id="deleteBtn">Delete</button>
    </div>
  </div>
  <div class="muted" id="metaLine" style="margin-top:6px"></div>

  <div class="grid" style="margin-top:12px">
    <div class="stack">
      <div class="card">
        <div class="mainImg" id="mainImg">No image</div>
        <div id="thumbs" class="thumbs" style="margin-top:10px"></div>
      </div>
      <div class="card">
        <h3 style="margin:0 0 8px">Description</h3>
        <div id="desc" class="muted">—</div>
      </div>
    </div>

    <div class="stack">
      <div class="card">
        <h3 style="margin:0 0 8px">Price</h3>
        <div class="muted" id="createdAt" style="margin-top:6px"></div>
        <div id="priceUSD" style="margin-top:8px;font-size:15px"></div>
      </div>

      <div id="buyBox" class="card" style="display:none">
        <h3 style="margin:0 0 8px">Buy with USDC (Base)</h3>
        <div id="buyStatus" class="muted">Connect your wallet to purchase.</div>
        <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
          <button id="connectWallet" class="btn ok">Connect Wallet</button>
          <button id="buyNow" class="btn main" style="display:none">Pay Now</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="overlay" id="overlay">
  <div class="lightbox">
    <button class="navBtn navPrev" id="prevBtn" aria-label="Previous">&lt;</button>
    <img id="overlayImg" alt="">
    <button class="navBtn navNext" id="nextBtn" aria-label="Next">&gt;</button>
    <button class="navBtn navClose" id="closeBtn" aria-label="Close">✕</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const sb = supabase.createClient(
  'https://wktxpukjmvmhzpctttjx.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndrdHhwdWtqbXZtaHpwY3R0dGp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxMjg2MjAsImV4cCI6MjA3MTcwNDYyMH0.07xzRjb_iQlkaObfslKiL9VZIHT8P3vnK-ZkIVm2qVY'
);

const itemTitle = document.getElementById('itemTitle');
const metaLine  = document.getElementById('metaLine');
const descEl    = document.getElementById('desc');
const createdAt = document.getElementById('createdAt');
const priceUSD  = document.getElementById('priceUSD');
const ownerTools= document.getElementById('ownerTools');
const editBtn   = document.getElementById('editBtn');
const deleteBtn = document.getElementById('deleteBtn');

const mainImg   = document.getElementById('mainImg');
const thumbsEl  = document.getElementById('thumbs');
const overlay   = document.getElementById('overlay');
const overlayImg= document.getElementById('overlayImg');
const prevBtn   = document.getElementById('prevBtn');
const nextBtn   = document.getElementById('nextBtn');
const closeBtn  = document.getElementById('closeBtn');

const buyBox     = document.getElementById('buyBox');
const buyStatus  = document.getElementById('buyStatus');
const connectBtn = document.getElementById('connectWallet');
const buyBtn     = document.getElementById('buyNow');

const BASE_CHAIN_ID_HEX = '0x2105';
const USDC_BASE = { chainId: BASE_CHAIN_ID_HEX, contract: '0x833589fCD6EDb6E08f4c7C32D4f71b54bdA02913', decimals: 6 };
const ERC20_ABI = ["function balanceOf(address) view returns (uint256)","function transfer(address to, uint256 value) returns (bool)"];
let provider=null, signer=null, buyerAddr=null;

const qs = new URLSearchParams(location.search);
const itemId = qs.get('id');

let me=null, item=null, images=[], idx=0;

function money(n){ return '$' + Number(n||0).toLocaleString(); }

(async function init(){
  if(!itemId){ itemTitle.textContent='Item not found'; return; }

  const { data:{ session } } = await sb.auth.getSession();
  me = session?.user || null;

  const iq = await sb.from('items')
    .select('id,title,description,user_value,created_at,owner_id,is_for_sale,price_usdc,sale_currency,profiles:owner_id(username,usdc_base_address)')
    .eq('id', itemId).maybeSingle();
  item = iq.data;
  if(!item){ itemTitle.textContent='Item not found'; return; }

  const im = await sb.from('items_images')
    .select('id,image_url,position,created_at')
    .eq('item_id', itemId)
    .order('position',{ascending:true})
    .order('created_at',{ascending:true});
  images = im.data || [];

  itemTitle.textContent = item.title || 'Untitled';
  metaLine.innerHTML = `Owner: ${item.profiles?.username ? `<a href="user.html?u=${encodeURIComponent(item.profiles.username)}">@${item.profiles.username}</a>` : 'unknown'}`;
  descEl.textContent = item.description || '—';
  priceUSD.textContent = 'Owner value: ' + money(item.user_value||0);
  createdAt.textContent = 'Added ' + new Date(item.created_at).toLocaleString();

  renderGallery();

  if (me){
    const my = await sb.from('profiles').select('role').eq('id', me.id).maybeSingle();
    const isModOrOwner = (my.data?.role==='moderator'||my.data?.role==='owner');
    if (me.id===item.owner_id || isModOrOwner){
      ownerTools.style.display='flex';
      editBtn.href='edit.html?id='+item.id;
      deleteBtn.onclick = async ()=>{
        if(!confirm('Delete this item?')) return;
        const { error } = await sb.from('items').delete().eq('id', item.id);
        if(error) return alert('Delete error: '+error.message);
        location.href='portfolio.html';
      };
    }
  }

  const sellerWallet = item.profiles?.usdc_base_address || null;
  const isForSale = !!item.is_for_sale && item.sale_currency==='USDC_BASE' && item.price_usdc>0;
  if (isForSale){
    const saleNote = document.createElement('div');
    saleNote.className='muted';
    saleNote.style.marginTop='6px';
    saleNote.textContent = `For sale: ${(item.price_usdc/1_000_000).toFixed(2)} USDC on Base`;
    createdAt.insertAdjacentElement('afterend', saleNote);
  }
  if (isForSale && me && me.id!==item.owner_id && sellerWallet){
    buyBox.style.display='block';
    buyStatus.textContent = `Price: ${(item.price_usdc/1_000_000).toFixed(2)} USDC — Network: Base`;
  }
})();

function renderGallery(){
  if (!images.length) {
    mainImg.textContent = 'No image';
    thumbsEl.innerHTML = '';
    return;
  }
  idx = 0;
  mainImg.innerHTML = `<img src="${images[0].image_url}" alt="">`;
  mainImg.onclick = openOverlay;
  thumbsEl.innerHTML = images.map((im, i)=>`<img data-i="${i}" src="${im.image_url}" class="${i===0?'sel':''}" alt="">`).join('');
  thumbsEl.querySelectorAll('img').forEach(t=>{
    t.addEventListener('click', ()=>{
      const i = Number(t.dataset.i);
      idx = i;
      mainImg.innerHTML = `<img src="${images[i].image_url}" alt="">`;
      thumbsEl.querySelectorAll('img').forEach(x=>x.classList.remove('sel'));
      t.classList.add('sel');
    });
  });
}

function openOverlay(){ if (!images.length) return; overlay.style.display='block'; overlayImg.src=images[idx].image_url; }
function closeOverlay(){ overlay.style.display='none'; }
function prev(){ if (!images.length) return; idx=(idx-1+images.length)%images.length; overlayImg.src=images[idx].image_url; }
function next(){ if (!images.length) return; idx=(idx+1)%images.length; overlayImg.src=images[idx].image_url; }
overlay.addEventListener('click', (e)=>{ if(e.target===overlay) closeOverlay(); });
closeBtn.addEventListener('click', closeOverlay);
prevBtn.addEventListener('click', (e)=>{ e.stopPropagation(); prev(); });
nextBtn.addEventListener('click', (e)=>{ e.stopPropagation(); next(); });
document.addEventListener('keydown', (e)=>{
  if (overlay.style.display==='block') {
    if (e.key==='Escape') closeOverlay();
    if (e.key==='ArrowLeft') prev();
    if (e.key==='ArrowRight') next();
  }
});

connectBtn?.addEventListener('click', async ()=>{
  try{
    if (!window.ethereum){ buyStatus.textContent='No wallet found. Install MetaMask or Coinbase Wallet.'; return; }
    await window.ethereum.request({ method:'eth_requestAccounts' });
    const current = await window.ethereum.request({ method:'eth_chainId' });
    if (current !== BASE_CHAIN_ID_HEX){
      try{
        await window.ethereum.request({ method:'wallet_switchEthereumChain', params:[{ chainId: BASE_CHAIN_ID_HEX }] });
      }catch(e){
        if (e.code===4902){
          await window.ethereum.request({
            method:'wallet_addEthereumChain',
            params:[{ chainId: BASE_CHAIN_ID_HEX, chainName:'Base',
              nativeCurrency:{ name:'ETH', symbol:'ETH', decimals:18 },
              rpcUrls:['https://mainnet.base.org'], blockExplorerUrls:['https://basescan.org'] }]
          });
        } else { throw e; }
      }
    }
    provider = new ethers.providers.Web3Provider(window.ethereum);
    signer   = provider.getSigner();
    buyerAddr= await signer.getAddress();
    buyStatus.textContent = `Wallet: ${buyerAddr.slice(0,6)}…${buyerAddr.slice(-4)} — ready`;
    buyBtn.style.display='';
  }catch(e){
    buyStatus.textContent = 'Wallet error: ' + (e?.message || e);
  }
});

buyBtn?.addEventListener('click', async ()=>{
  try{
    if (!signer){ buyStatus.textContent='Connect your wallet first.'; return; }
    if (!item?.profiles?.usdc_base_address){ buyStatus.textContent='Seller wallet is missing.'; return; }

    const seller = item.profiles.usdc_base_address;
    const amount = ethers.BigNumber.from(String(item.price_usdc));
    const usdc = new ethers.Contract(USDC_BASE.contract, ERC20_ABI, signer);

    buyStatus.textContent='Sending USDC…';
    const tx  = await usdc.transfer(seller, amount);
    buyStatus.textContent='Waiting for confirmation…';
    const rec = await tx.wait();

    const { data:{ session } } = await sb.auth.getSession();
    await sb.from('orders').insert({
      item_id: item.id,
      seller_id: item.owner_id,
      buyer_id: session.user.id,
      price_usdc: item.price_usdc,
      currency: 'USDC',
      method: 'USDC_BASE',
      status: 'paid',
      tx_hash: rec.transactionHash,
      chain_id: BASE_CHAIN_ID_HEX
    });

    buyStatus.textContent='Payment confirmed. View it in Orders.';
  }catch(e){
    buyStatus.textContent = 'Payment failed: ' + (e?.error?.message || e?.message || e);
  }
});
</script>
</body>
</html>
