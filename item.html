<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Item — Scream Collector</title>
<style>
  :root{--bg:#111;--panel:#1b1b1b;--ink:#eee;--muted:#a9adb4;--accent:#dc143c;--ok:#2a6}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:Arial,Helvetica,sans-serif}
  a{color:#9ecbff;text-decoration:none}
  .wrap{max-width:1100px;margin:0 auto;padding:24px}
  .grid{display:grid;grid-template-columns:1fr 360px;gap:20px}
  .card{background:var(--panel);border-radius:12px;padding:16px}
  .muted{color:var(--muted)} .ok{color:#9f9}.err{color:#f88}
  .title{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .btn{background:#444;color:#fff;border:none;border-radius:8px;padding:8px 12px;cursor:pointer;text-decoration:none}
  .btn.main{background:var(--accent)}
  .btn.ok{background:var(--ok)}
  .stack{display:grid;gap:12px}
  .mainImg{background:#171717;border-radius:12px;display:flex;align-items:center;justify-content:center;min-height:320px;overflow:hidden;cursor:pointer}
  .mainImg img{max-width:100%;max-height:520px;display:block}
  .thumbs{display:flex;gap:10px;flex-wrap:wrap}
  .thumbs img{width:90px;height:90px;object-fit:cover;border-radius:8px;border:2px solid transparent;cursor:pointer}
  .thumbs img.sel{border-color:#4ade80}
  /* lightbox */
  .overlay{position:fixed;inset:0;display:none;background:rgba(0,0,0,.85);z-index:999}
  .lightbox{position:absolute;inset:0;display:flex;align-items:center;justify-content:center}
  .lightbox img{max-width:92vw;max-height:92vh;border-radius:8px}
  .navBtn{position:absolute;top:50%;transform:translateY(-50%);font-size:28px;background:#222;border:1px solid #333;border-radius:999px;padding:8px 12px;cursor:pointer;color:#eee;opacity:.9}
  .navBtn:hover{opacity:1}
  .navPrev{left:24px} .navNext{right:24px}
  .navClose{position:absolute;top:18px;right:18px;padding:8px 10px}
  /* vote UI */
  .voteBox{background:#161616;border:1px solid #2a2a2a;border-radius:12px;padding:14px}
  .voteRow{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .voteBtn{background:#333;color:#fff;border:none;border-radius:8px;padding:8px 12px;cursor:pointer}
  .voteBtn.active{outline:2px solid #4ade80}
  .voteInput{display:none;gap:8px;align-items:center}
  .voteInput input{width:140px;background:#222;border:1px solid #333;color:#eee;padding:8px;border-radius:6px}
  .voteStats{margin-top:10px;color:var(--muted)}
  .bar{height:10px;background:#222;border-radius:999px;overflow:hidden}
  .bar > span{display:block;height:100%;background:#2a6;width:0%}
  .ownerTools{display:flex;gap:8px;flex-wrap:wrap}
</style>

<!-- Ethers (for on-chain USDC transfers) -->
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
</head>
<body>
<app-menu></app-menu>
<script type="module" src="/menu.js"></script>

<div class="wrap">
  <a href="index.html">← Back</a>

  <div class="title" style="margin-top:8px">
    <h1 id="itemTitle" style="margin:0">Loading…</h1>
    <div class="ownerTools" id="ownerTools" style="display:none">
      <a class="btn" id="editBtn">Edit</a>
      <button class="btn" id="deleteBtn">Delete</button>
    </div>
  </div>
  <div class="muted" id="metaLine" style="margin-top:6px"></div>

  <div class="grid" style="margin-top:12px">
    <!-- Left: gallery + description -->
    <div class="stack">
      <div class="card">
        <div class="mainImg" id="mainImg">No image</div>
        <div id="thumbs" class="thumbs" style="margin-top:10px"></div>
      </div>
      <div class="card">
        <h3 style="margin:0 0 8px">Description</h3>
        <div id="desc" class="muted">—</div>
      </div>
    </div>

    <!-- Right: price + buy + votes -->
    <div class="stack">
      <div class="card">
        <h3 style="margin:0 0 8px">Price</h3>
        <div style="font-size:28px;font-weight:700" id="price">$0</div>
        <div class="muted" id="saleLine" style="margin-top:6px"></div>

        <!-- Buy card (USDC on Base) -->
        <div id="buyCard" class="card" style="display:none;margin-top:12px">
          <h3 style="margin:0 0 8px">Buy with USDC (Base)</h3>
          <p class="muted" style="margin:0 0 8px">Payments go directly to the seller’s wallet.</p>
          <button id="buyBtn" class="btn ok" style="background:#2a6">Buy Now</button>
          <div id="buyMsg" class="muted" style="margin-top:6px"></div>
        </div>

        <div class="muted" id="createdAt" style="margin-top:6px"></div>
      </div>

      <div class="card">
        <h3 style="margin:0 0 8px">Community Vote</h3>
        <div class="voteStats" id="aggText">Agree: 0 • Disagree: 0</div>
        <div class="bar" style="margin-top:8px"><span id="agreeFill" style="width:0%"></span></div>
        <div class="voteStats" id="avgLine" style="margin-top:6px">Average suggested: —</div>

        <div class="voteBox" id="voteBox" style="display:none;margin-top:12px">
          <div class="voteRow">
            <button id="agreeBtn" class="voteBtn">Agree</button>
            <button id="disagreeBtn" class="voteBtn">Disagree</button>
            <span id="bandHint" class="voteStats"></span>
          </div>
          <div id="disagreeBlock" class="voteInput" style="margin-top:8px">
            <label for="suggestPrice">Suggest price:</label>
            <input id="suggestPrice" type="number" step="1" min="0"/>
            <button id="saveSuggestion" class="voteBtn ok">Save</button>
          </div>
          <div class="voteStats" id="voteMsg"></div>
        </div>

        <div class="voteStats" id="guestMsg" style="display:none;margin-top:10px">
          <a href="login.html?next=item.html%3Fid%3D" id="loginLink">Log in</a> to vote.
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Lightbox overlay -->
<div class="overlay" id="overlay">
  <div class="lightbox">
    <button class="navBtn navPrev" id="prevBtn" aria-label="Previous">&lt;</button>
    <img id="overlayImg" alt="">
    <button class="navBtn navNext" id="nextBtn" aria-label="Next">&gt;</button>
    <button class="navBtn navClose" id="closeBtn" aria-label="Close">✕</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const sb = supabase.createClient(
  'https://wktxpukjmvmhzpctttjx.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndrdHhwdWtqbXZtaHpwY3R0dGp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxMjg2MjAsImV4cCI6MjA3MTcwNDYyMH0.07xzRjb_iQlkaObfslKiL9VZIHT8P3vnK-ZkIVm2qVY'
);

// DOM refs
const itemTitle=document.getElementById('itemTitle');
const metaLine=document.getElementById('metaLine');
const descEl=document.getElementById('desc');
const priceEl=document.getElementById('price');
const saleLine=document.getElementById('saleLine');
const createdAt=document.getElementById('createdAt');
const ownerTools=document.getElementById('ownerTools');
const editBtn=document.getElementById('editBtn');
const deleteBtn=document.getElementById('deleteBtn');
const mainImg=document.getElementById('mainImg');
const thumbsEl=document.getElementById('thumbs');
const overlay=document.getElementById('overlay');
const overlayImg=document.getElementById('overlayImg');
const prevBtn=document.getElementById('prevBtn');
const nextBtn=document.getElementById('nextBtn');
const closeBtn=document.getElementById('closeBtn');

// Voting refs
const voteBox=document.getElementById('voteBox');
const agreeBtn=document.getElementById('agreeBtn');
const disagreeBtn=document.getElementById('disagreeBtn');
const disagreeBlock=document.getElementById('disagreeBlock');
const suggestPriceEl=document.getElementById('suggestPrice');
const saveSuggestionBtn=document.getElementById('saveSuggestion');
const voteMsg=document.getElementById('voteMsg');
const aggText=document.getElementById('aggText');
const agreeFill=document.getElementById('agreeFill');
const avgLine=document.getElementById('avgLine');
const bandHint=document.getElementById('bandHint');
const guestMsg=document.getElementById('guestMsg');
const loginLink=document.getElementById('loginLink');

let me=null,item=null,owner=null;
let basePrice=0,minBand=0,maxBand=0;
let images=[],idx=0;

// Helpers
function money(n){return '$'+Number(n||0).toLocaleString();}
function setActive(which){
  agreeBtn.classList.toggle('active',which==='agree');
  disagreeBtn.classList.toggle('active',which==='disagree');
  disagreeBlock.style.display=which==='disagree'?'flex':'none';
}
function setVoteMsg(t,ok=false){voteMsg.textContent=t;voteMsg.style.color=ok?'#9f9':'#a9adb4';}

// INIT
(async function init(){
  const params=new URLSearchParams(location.search);
  const rawId=decodeURIComponent(String(params.get('id')||params.get('itemId')||'')).trim();
  if(!rawId){ itemTitle.textContent='Item not found'; return; }

  const coerceBool=v=>v===true||v===1||v==='1'||v==='true'||v==='t';
  let row=null,saleFlag=null;

  // Try with for_sale + sold fields
  const q1=await sb.from('items')
    .select('id,title,description,user_value,created_at,owner_id,for_sale,sold,sold_price,sold_at')
    .eq('id',rawId).maybeSingle();

  if(q1.data){ row=q1.data; saleFlag=q1.data.for_sale; }
  else{
    // Fallback without for_sale in case of RLS
    const q2=await sb.from('items')
      .select('id,title,description,user_value,created_at,owner_id,sold,sold_price,sold_at')
      .eq('id',rawId).maybeSingle();
    if(q2.data){ row=q2.data; }
  }
  if(!row){ itemTitle.textContent='Item not found'; return; }

  item=row;
  item.for_sale=coerceBool(saleFlag);

  const {data:{session}}=await sb.auth.getSession();
  me=session?.user||null;
  loginLink.href='login.html?next='+encodeURIComponent('item.html?id='+item.id);

  const pq=await sb.from('profiles').select('username,usdc_base_address,role').eq('id',item.owner_id).maybeSingle();
  owner=pq.data||null;

  const im=await sb.from('items_images')
    .select('id,image_url,position,created_at')
    .eq('item_id',item.id)
    .order('position',{ascending:true})
    .order('created_at',{ascending:true});
  images=im.data||[];

  // Render basics
  itemTitle.textContent=item.title||'Untitled';
  metaLine.innerHTML=`Owner: ${owner?.username?`<a href="user.html?u=${encodeURIComponent(owner.username)}">@${owner.username}</a>`:'unknown'}`;
  descEl.textContent=item.description||'—';
  basePrice=Number(item.user_value||0);
  createdAt.textContent='Added '+new Date(item.created_at).toLocaleString();

  // SOLD UI
  if (item.sold === true) {
    // Big price shows sold price
    priceEl.textContent = money(item.sold_price || 0);
    // Sale line explains it was sold
    const soldDate = item.sold_at ? new Date(item.sold_at).toLocaleString() : '';
    saleLine.textContent = `Sold for ${money(item.sold_price || 0)}${soldDate ? ' on ' + soldDate : ''}.`;
  } else {
    // Not sold → show current sale state
    priceEl.textContent = money(basePrice);
    if(saleFlag===undefined||saleFlag===null){ 
      saleLine.textContent='—'; 
    } else { 
      saleLine.textContent=item.for_sale?'This item is listed for sale.':'Not for sale.'; 
    }
  }

  renderGallery();

  // Owner/mod tools
  if(me){
    const my=await sb.from('profiles').select('role').eq('id',me.id).maybeSingle();
    const role=my.data?.role||'free';
    const isModOrOwner=(me.id===item.owner_id)||(role==='moderator'||role==='owner');
    if(isModOrOwner){
      ownerTools.style.display='flex';
      editBtn.href='edit.html?id='+item.id;
      deleteBtn.onclick=async()=>{
        if(!confirm('Delete this item?'))return;
        const {error}=await sb.from('items').delete().eq('id',item.id);
        if(error)return alert('Delete error: '+error.message);
        location.href='portfolio.html';
      };
    }
  }

  // Voting
  if(me){
    voteBox.style.display='block';
    minBand=Math.round(basePrice*0.70);
    maxBand=Math.round(basePrice*1.30);
    bandHint.textContent=`If you disagree, suggest between ${money(minBand)} and ${money(maxBand)}.`;
    await refreshMyVote();
  } else {
    guestMsg.style.display='block';
  }
  await refreshAggregates();

  // Buy feature (already hides if sold)
  await setupBuyFeature();
})();

// Gallery
function renderGallery(){
  if(!images.length){ mainImg.textContent='No image'; thumbsEl.innerHTML=''; return; }
  idx=0;
  mainImg.innerHTML=`<img src="${images[0].image_url}" alt="">`;
  mainImg.onclick=openOverlay;
  thumbsEl.innerHTML=images.map((im,i)=>`<img data-i="${i}" src="${im.image_url}" class="${i===0?'sel':''}" alt="">`).join('');
  thumbsEl.querySelectorAll('img').forEach(t=>{
    t.addEventListener('click',()=>{
      const i=Number(t.dataset.i);
      idx=i;
      mainImg.innerHTML=`<img src="${images[i].image_url}" alt="">`;
      thumbsEl.querySelectorAll('img').forEach(x=>x.classList.remove('sel'));
      t.classList.add('sel');
    });
  });
}

// Lightbox
function openOverlay(){ if(!images.length)return; overlay.style.display='block'; overlayImg.src=images[idx].image_url; }
function closeOverlay(){ overlay.style.display='none'; }
function prev(){ if(!images.length)return; idx=(idx-1+images.length)%images.length; overlayImg.src=images[idx].image_url; }
function next(){ if(!images.length)return; idx=(idx+1)%images.length; overlayImg.src=images[idx].image_url; }
overlay.addEventListener('click',e=>{ if(e.target===overlay) closeOverlay(); });
closeBtn.addEventListener('click',closeOverlay);
prevBtn.addEventListener('click',e=>{ e.stopPropagation(); prev(); });
nextBtn.addEventListener('click',e=>{ e.stopPropagation(); next(); });
document.addEventListener('keydown',e=>{
  if(overlay.style.display==='block'){
    if(e.key==='Escape') closeOverlay();
    if(e.key==='ArrowLeft') prev();
    if(e.key==='ArrowRight') next();
  }
});

// Voting
async function refreshMyVote(){
  if(!me)return;
  const currentId=item?.id;
  const {data:row}=await sb.from('item_votes')
    .select('agree,suggested_price')
    .eq('item_id',currentId)
    .eq('voter_id',me.id)
    .maybeSingle();
  if(!row){ setActive(null); suggestPriceEl.value=''; setVoteMsg('You have not voted yet.'); return; }
  if(row.agree){ setActive('agree'); setVoteMsg('You agree with the price.',true); }
  else{ setActive('disagree'); suggestPriceEl.value=row.suggested_price??''; setVoteMsg('You disagree. Adjust your suggestion and save.',true); }
}
async function refreshAggregates(){
  const currentId=item?.id;
  const {data:rows}=await sb.from('item_votes').select('agree,suggested_price').eq('item_id',currentId);
  let agrees=0,disagrees=0,sum=0,n=0;
  for(const r of rows||[]){ if(r.agree) agrees++; else {disagrees++; if(typeof r.suggested_price==='number'){sum+=r.suggested_price;n++;}}}
  const total=agrees+disagrees, pct= total? Math.round(agrees*100/total):0;
  agreeFill.style.width=pct+'%';
  aggText.textContent=`Agree: ${agrees} • Disagree: ${disagrees} • ${pct}% agree`;
  avgLine.textContent= n? `Average suggested: ${money(Math.round(sum/n))}` : 'Average suggested: —';
}
agreeBtn.addEventListener('click', async ()=>{
  if(!me)return;
  const currentId=item?.id;
  setActive('agree'); setVoteMsg('Saving…');
  const {error}=await sb.from('item_votes').upsert(
    { item_id:currentId, voter_id:me.id, agree:true, suggested_price:null },
    { onConflict:'item_id,voter_id' }
  );
  if(error) return setVoteMsg('Error: '+error.message);
  setVoteMsg('You agree with the price.',true); await refreshAggregates();
});
disagreeBtn.addEventListener('click', ()=>{
  if(!me)return;
  setActive('disagree'); setVoteMsg(`Enter a suggestion within ${money(minBand)}–${money(maxBand)}.`);
  if(!suggestPriceEl.value) suggestPriceEl.value=Math.round(basePrice);
});
saveSuggestionBtn.addEventListener('click', async ()=>{
  if(!me)return;
  const currentId=item?.id;
  const val=Math.round(Number(suggestPriceEl.value||0));
  if(!val) return setVoteMsg('Enter a number.');
  if(val<Math.round(basePrice*0.70)||val>Math.round(basePrice*1.30)) return setVoteMsg(`Must be between ${money(Math.round(basePrice*0.70))} and ${money(Math.round(basePrice*1.30))}.`);
  setVoteMsg('Saving…');
  const {error}=await sb.from('item_votes').upsert(
    { item_id:currentId, voter_id:me.id, agree:false, suggested_price:val },
    { onConflict:'item_id,voter_id' }
  );
  if(error) return setVoteMsg('Error: '+error.message);
  setVoteMsg('Saved your suggestion.',true); await refreshAggregates();
});

// USDC BUY FEATURE
async function setupBuyFeature(){
  const buyCard=document.getElementById('buyCard');
  const buyBtn=document.getElementById('buyBtn');
  const buyMsg=document.getElementById('buyMsg');

  try{
    if(item?.sold===true){ if(buyCard) buyCard.style.display='none'; return; }
    if(item?.for_sale!==true) return;

    let sellerAddr;
    try{
      sellerAddr=ethers.utils.getAddress(String((await sb.from('profiles').select('usdc_base_address').eq('id',item.owner_id).maybeSingle()).data?.usdc_base_address||'').trim());
    }catch{ console.warn('Seller wallet missing/invalid'); return; }

    const USDC_BASE=ethers.utils.getAddress('0x833589fcd6edb6e08f4c7c32d4f71b54bda02913');
    const USDC_ABI=[
      'function transfer(address to, uint256 amount) public returns (bool)',
      'function decimals() public view returns (uint8)'
    ];

    buyCard.style.display='block';

    buyBtn.addEventListener('click', async ()=>{
      buyMsg.textContent='Connecting wallet...';
      if(!window.ethereum){ buyMsg.textContent='No wallet found (MetaMask / Coinbase).'; return; }

      try{
        const provider=new ethers.providers.Web3Provider(window.ethereum);
        await provider.send('eth_requestAccounts',[]);
        const signer=provider.getSigner();
        const network=await provider.getNetwork();
        if(network.chainId!==8453){ buyMsg.textContent='Please switch to Base network.'; return; }

        const usdc=new ethers.Contract(USDC_BASE,USDC_ABI,signer);
        const price=ethers.utils.parseUnits(String(item.user_value||0),6);

        buyMsg.textContent='Sending payment...';
        const tx=await usdc.transfer(sellerAddr,price);
        buyMsg.textContent='Waiting for confirmation...';
        await tx.wait();
        buyMsg.textContent='✅ Payment complete! Tx hash: '+tx.hash;
      }catch(err){
        console.error(err);
        buyMsg.textContent='Payment failed: '+(err.message||err);
      }
    });
  }catch(e){ console.error('setupBuyFeature error',e); }
}
</script>
</body>
</html>

