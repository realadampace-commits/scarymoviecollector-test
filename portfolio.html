<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>My Portfolio</title>
<style>
  body{margin:0;background:#111;color:#eee;font-family:Arial,Helvetica,sans-serif}
  .wrap{max-width:1000px;margin:0 auto;padding:24px}
  .head{display:flex;justify-content:space-between;align-items:center}
  a.btn{background:crimson;color:#fff;border:none;border-radius:6px;padding:10px 16px;cursor:pointer;text-decoration:none}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:16px;margin-top:16px}
  .card{background:#1c1c1c;border-radius:10px;overflow:hidden}
  .thumb{height:160px;background:#222;display:flex;align-items:center;justify-content:center}
  .thumb img{max-width:100%;max-height:100%}
  .meta{padding:10px}
  .owner{display:flex;align-items:center;gap:8px;opacity:.8;font-size:12px;margin-top:4px}
  .ava{width:20px;height:20px;border-radius:50%;background:#333;display:inline-block;overflow:hidden}
  .ava img{width:100%;height:100%;object-fit:cover;display:block}
  .muted{opacity:.7}
</style>
</head>
<body>
<app-menu></app-menu>
<script type="module" src="/menu.js"></script>

<div class="wrap">
  <div class="head">
    <a href="index.html">← Home</a>
    <div>
      <a class="btn" href="create.html">Add Item</a>
      <a class="btn" href="settings.html" style="background:#444">Settings</a>
    </div>
  </div>

  <h2 id="title">My Portfolio</h2>
  <div id="total" class="muted">Total: $0</div>

  <div id="items" class="grid" style="margin-top:10px"></div>
  <div id="msg" class="muted" style="margin-top:10px"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const sb = supabase.createClient(
  'https://wktxpukjmvmhzpctttjx.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndrdHhwdWtqbXZtaHpwY3R0dGp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxMjg2MjAsImV4cCI6MjA3MTcwNDYyMH0.07xzRjb_iQlkaObfslKiL9VZIHT8P3vnK-ZkIVm2qVY'
);

// helper: attach first photo from items_images as preview_url
async function attachPreviews(items){
  if (!items?.length) return items;
  const ids = items.map(i=>i.id);
  const { data: imgs, error } = await sb
    .from('items_images')
    .select('item_id,image_url,position,created_at')
    .in('item_id', ids)
    .order('position',{ascending:true})
    .order('created_at',{ascending:true});
  if (error) { console.warn('preview query error:', error); return items; }
  const first = {};
  (imgs||[]).forEach(im => { if (!first[im.item_id]) first[im.item_id] = im.image_url; });
  return items.map(i => ({ ...i, preview_url: first[i.id] || null }));
}

(async ()=>{
  const qs      = new URLSearchParams(location.search);
  const uname   = qs.get('u'); // if present, show that user's portfolio
  const msgEl   = document.getElementById('msg');
  const itemsEl = document.getElementById('items');
  const totalEl = document.getElementById('total');
  const titleEl = document.getElementById('title');
  const myActions = document.getElementById('myActions');

  let ownerId = null;
  let ownerUsername = null;
  let ownerAvatar = null;

  if (uname) {
    // Viewing someone else's portfolio — no login required
    const { data: owner, error } = await sb.from('profiles')
      .select('id,username,avatar_url')
      .eq('username', uname)
      .maybeSingle();
    if (error || !owner){
      msgEl.textContent = 'User not found.'; return;
    }
    ownerId = owner.id;
    ownerUsername = owner.username;
    ownerAvatar = owner.avatar_url;
    titleEl.textContent = '@' + ownerUsername + ' — Portfolio';
    // Hide my actions when browsing someone else
    if (myActions) myActions.style.display = 'none';
  } else {
    // Viewing my own portfolio — require login
    const { data:{ session } } = await sb.auth.getSession();
    if (!session){ alert('Please log in first'); location.href='login.html?next=portfolio.html'; return; }
    ownerId = session.user.id;

    const { data: profile } = await sb.from('profiles')
      .select('username,avatar_url')
      .eq('id', ownerId).maybeSingle();
    ownerUsername = profile?.username || 'me';
    ownerAvatar   = profile?.avatar_url || null;
    if (profile?.username) titleEl.textContent = '@' + profile.username + ' — Portfolio';
    // Keep my actions visible
    if (myActions) myActions.style.display = '';
  }

  // Load items for ownerId (same query; join to show owner info on cards)
  const { data, error } = await sb.from('items')
    .select('id,title,user_value,created_at,owner_id,profiles:owner_id(username,avatar_url)')
    .eq('owner_id', ownerId)
    .order('created_at',{ascending:false});

  if (error){
    console.error('items error:', error);
    msgEl.textContent = 'Error loading items: ' + error.message;
    return;
  }
  if (!data || data.length===0){
    msgEl.textContent = 'No items yet.';
    totalEl.textContent = 'Total: $0';
    itemsEl.innerHTML = '';
    return;
  }

  const withPrev = await attachPreviews(data);

  const total = withPrev.reduce((s,it)=> s + (it.user_value||0), 0);
  totalEl.textContent = 'Total: $' + total.toLocaleString();
  msgEl.textContent = '';

  itemsEl.innerHTML = withPrev.map(it => {
    const avaSrc = it.profiles?.avatar_url || ownerAvatar;
    const ava = avaSrc
      ? `<span class="ava"><img src="${avaSrc}" alt=""></span>`
      : `<span class="ava"></span>`;
    const unameForCard = it.profiles?.username || ownerUsername || 'user';
    return `
      <div class="card">
        <a href="item.html?id=${it.id}" style="color:inherit;text-decoration:none">
          <div class="thumb">${it.preview_url ? `<img src="${it.preview_url}" alt="">` : 'No image'}</div>
          <div class="meta">
            <div><strong>${it.title}</strong></div>
            <div class="owner">${ava}<span>@${unameForCard}</span></div>
            <div>$${(it.user_value||0).toLocaleString()}</div>
          </div>
        </a>
        ${uname ? '' : `
          <div style="display:flex;gap:8px;padding:0 10px 12px">
            <a class="btn" href="edit.html?id=${it.id}" style="background:#444;padding:8px 12px">Edit</a>
            <a class="btn" href="item.html?id=${it.id}" style="background:#666;padding:8px 12px">View</a>
          </div>
        `}
      </div>
    `;
  }).join('');
})();
</script>
</body>
</html>

