<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Add Item</title>
<style>
  body{margin:0;background:#111;color:#eee;font-family:Arial,Helvetica,sans-serif}
  .wrap{max-width:720px;margin:0 auto;padding:24px}
  input,textarea,button{width:100%;padding:10px;margin-top:10px;border-radius:6px;border:1px solid #333;background:#222;color:#eee}
  button{border:none;background:crimson;cursor:pointer}
  a{color:#9ecbff;text-decoration:none}
  .ok{color:#9f9}.err{color:#f88}
</style>
</head>
<body>
<app-menu></app-menu>
<script type="module" src="/menu.js"></script>

<div class="wrap">
  <a href="index.html">‚Üê Home</a>
  <h2>Add Item</h2>
  <input id="title" placeholder="Title" />
  <textarea id="desc" placeholder="Description"></textarea>
  <input id="value" type="number" min="0" placeholder="Value (USD)" />
  <input id="file" type="file" accept="image/*" />
  <button id="create">Create</button>
  <div id="msg" style="margin-top:10px;opacity:.95;white-space:pre-wrap"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const sb = supabase.createClient('https://wktxpukjmvmhzpctttjx.supabase.co',
'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndrdHhwdWtqbXZtaHpwY3R0dGp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxMjg2MjAsImV4cCI6MjA3MTcwNDYyMH0.07xzRjb_iQlkaObfslKiL9VZIHT8P3vnK-ZkIVm2qVY');
const BUCKET = 'item-images';

function show(t, cls=''){ const m=document.getElementById('msg'); m.className=cls; m.textContent=t; }
function append(t){ const m=document.getElementById('msg'); m.textContent=(m.textContent?m.textContent+'\n':'')+t; }

document.getElementById('create').onclick = async ()=>{
  try{
    show('Checking session...');
    const { data:{ session } } = await sb.auth.getSession();
    if (!session){ alert('Please login first'); location.href='login.html'; return; }

    // Free-tier / subscriber check
    const { data: me } = await sb.from('profiles').select('role').eq('id', session.user.id).maybeSingle();
    if (me?.role === 'free') {
      const { count } = await sb.from('items').select('id', { count: 'exact', head: true }).eq('owner_id', session.user.id);
      if ((count ?? 0) >= 5) {
        show('Free tier limit reached (5 items). Upgrade to subscriber to add more.', 'err');
        return;
      }
    }

    // Ensure profile
    append('Ensuring profile...');
    const { data: prof } = await sb.from('profiles').select('id').eq('id', session.user.id).maybeSingle();
    if (!prof){ await sb.from('profiles').insert({ id: session.user.id, username: session.user.email.split('@')[0] }); }

    const title = document.getElementById('title').value.trim();
    const description = document.getElementById('desc').value.trim();
    const user_value = Number(document.getElementById('value').value) || 0;
    const file = document.getElementById('file').files[0];
    if (!title){ show('Please enter a title.', 'err'); return; }

    append('Creating item row...');
    const ins = await sb.from('items').insert({ owner_id: session.user.id, title, description, user_value }).select().single();
    if (ins.error){ show('DB insert error: ' + ins.error.message, 'err'); return; }
    const itemId = ins.data.id;

    let publicUrl = null;
    if (file){
      append('Uploading image...');
      const safeName = file.name.replace(/[^\w.\-]+/g,'_');
      const path = `items/${session.user.id}/${itemId}/main-${Date.now()}-${safeName}`;
      const up = await sb.storage.from(BUCKET).upload(path, file, { upsert:true, contentType:file.type });
      if (up.error){ show('Upload error: ' + up.error.message, 'err'); return; }

      publicUrl = sb.storage.from(BUCKET).getPublicUrl(path).data.publicUrl;
      append('Image URL: ' + publicUrl);
      const upd = await sb.from('items').update({ image_url: publicUrl }).eq('id', itemId);
      if (upd.error){ show('DB update error (image_url): ' + upd.error.message, 'err'); return; }
    }

    show('Item created successfully. Redirecting...', 'ok');
    location.href = 'item.html?id=' + itemId;

  }catch(e){
    show('Unexpected error: ' + (e?.message || e), 'err');
    console.error(e);
  }
};
</script>
</body>
</html>
