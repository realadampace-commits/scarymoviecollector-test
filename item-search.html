<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Item — Scream Collector</title>
<style>
  :root{--bg:#111;--panel:#1b1b1b;--ink:#eee;--muted:#a9adb4;--accent:#dc143c;--ok:#2a6}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:Arial,Helvetica,sans-serif}
  a{color:#9ecbff;text-decoration:none}
  .wrap{max-width:1100px;margin:0 auto;padding:24px}
  .grid{display:grid;grid-template-columns:1fr 360px;gap:20px}
  .card{background:var(--panel);border-radius:12px;padding:16px}
  .muted{color:var(--muted)} .ok{color:#9f9}.err{color:#f88}
  .title{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .btn{background:#444;color:#fff;border:none;border-radius:8px;padding:8px 12px;cursor:pointer;text-decoration:none}
  .btn.main{background:var(--accent)}
  .btn.ok{background:var(--ok)}
  .stack{display:grid;gap:12px}
  .mainImg{background:#171717;border-radius:12px;display:flex;align-items:center;justify-content:center;min-height:320px;overflow:hidden;cursor:pointer}
  .mainImg img{max-width:100%;max-height:520px;display:block}
  .thumbs{display:flex;gap:10px;flex-wrap:wrap}
  .thumbs img{width:90px;height:90px;object-fit:cover;border-radius:8px;border:2px solid transparent;cursor:pointer}
  .thumbs img.sel{border-color:#4ade80}
  .overlay{position:fixed;inset:0;display:none;background:rgba(0,0,0,.85);z-index:999}
  .lightbox{position:absolute;inset:0;display:flex;align-items:center;justify-content:center}
  .lightbox img{max-width:92vw;max-height:92vh;border-radius:8px}
  .navBtn{position:absolute;top:50%;transform:translateY(-50%);font-size:28px;background:#222;border:1px solid #333;border-radius:999px;padding:8px 12px;cursor:pointer;color:#eee;opacity:.9}
  .navBtn:hover{opacity:1}
  .navPrev{left:24px} .navNext{right:24px}
  .navClose{position:absolute;top:18px;right:18px;padding:8px 10px}
  .voteBox{background:#161616;border:1px solid #2a2a2a;border-radius:12px;padding:14px}
  .voteRow{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .voteBtn{background:#333;color:#fff;border:none;border-radius:8px;padding:8px 12px;cursor:pointer}
  .voteBtn.active{outline:2px solid #4ade80}
  .voteInput{display:none;gap:8px;align-items:center}
  .voteInput input{width:140px;background:#222;border:1px solid #333;color:#eee;padding:8px;border-radius:6px}
  .voteStats{margin-top:10px;color:var(--muted)}
  .bar{height:10px;background:#222;border-radius:999px;overflow:hidden}
  .bar > span{display:block;height:100%;background:#2a6;width:0%}
  .ownerTools{display:flex;gap:8px;flex-wrap:wrap}
</style>
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<script>
  // Single source of truth — checksummed at runtime by ethers
  window.USDC_BASE = ethers.utils.getAddress(
    '0x833589fcd6edb6e08f4c7c32d4f71b54bda02913' // lowercase input; ethers returns proper checksum
  );
</script>
</head>
<body>
<app-menu></app-menu>
<script type="module" src="/menu.js"></script>

<div class="wrap">
  <a href="index.html">← Back</a>

  <div class="title" style="margin-top:8px">
    <h1 id="itemTitle" style="margin:0">Loading…</h1>
    <div class="ownerTools" id="ownerTools" style="display:none">
      <a class="btn" id="editBtn">Edit</a>
      <button class="btn" id="deleteBtn">Delete</button>
    </div>
  </div>
  <div class="muted" id="metaLine" style="margin-top:6px"></div>

  <div class="grid" style="margin-top:12px">
    <div class="stack">
      <div class="card">
        <div class="mainImg" id="mainImg">No image</div>
        <div id="thumbs" class="thumbs" style="margin-top:10px"></div>
      </div>
      <div class="card">
        <h3 style="margin:0 0 8px">Description</h3>
        <div id="desc" class="muted">—</div>
      </div>
    </div>

    <div class="stack">
      <div class="card">
        <h3 style="margin:0 0 8px">Price</h3>
        <div style="font-size:28px;font-weight:700" id="price">$0</div>
        <div class="muted" id="createdAt" style="margin-top:6px"></div>
      </div>

      <div id="buyCard" class="card" style="display:none">
        <h3 style="margin:0 0 8px">Purchase Item</h3>
        <p class="muted">This item is listed for sale. Payments are in <strong>USDC on Base</strong>.</p>
        <button id="buyBtn" class="btn ok" style="background:#2a6">Buy with USDC</button>
        <div id="buyMsg" class="muted" style="margin-top:6px"></div>
      </div>

      <div class="card">
        <h3 style="margin:0 0 8px">Community Vote</h3>
        <div class="voteStats" id="aggText">Agree: 0 • Disagree: 0</div>
        <div class="bar" style="margin-top:8px"><span id="agreeFill" style="width:0%"></span></div>
        <div class="voteStats" id="avgLine" style="margin-top:6px">Average suggested: —</div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const sb = supabase.createClient(
  'https://wktxpukjmvmhzpctttjx.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndrdHhwdWtqbXZtaHpwY3R0dGp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxMjg2MjAsImV4cCI6MjA3MTcwNDYyMH0.07xzRjb_iQlkaObfslKiL9VZIHT8P3vnK-ZkIVm2qVY'
);
// Normalize to a proper EIP-55 checksummed address

const USDC_ABI = [
  "function transfer(address to, uint256 amount) public returns (bool)",
  "function decimals() public view returns (uint8)"
];

const qs = new URLSearchParams(location.search);
const itemId = qs.get('id');

let me=null, item=null;

(async function init(){
  if(!itemId){ document.getElementById('itemTitle').textContent='Item not found'; return; }

  const { data:{ session } } = await sb.auth.getSession();
  me = session?.user || null;

  const q = await sb.from('items')
    .select('id,title,description,user_value,created_at,owner_id,for_sale,profiles:owner_id(username,usdc_base_address)')
    .eq('id', itemId).maybeSingle();
  if (!q.data){ document.getElementById('itemTitle').textContent='Item not found'; return; }
  item = q.data;

  document.getElementById('itemTitle').textContent = item.title || 'Untitled';
  document.getElementById('desc').textContent = item.description || '—';
  document.getElementById('price').textContent = '$' + (item.user_value || 0);
  document.getElementById('createdAt').textContent = 'Added ' + new Date(item.created_at).toLocaleString();

  setupBuyFeature();
})();

async function setupBuyFeature() {
  const buyCard = document.getElementById('buyCard');
  const buyBtn = document.getElementById('buyBtn');
  const buyMsg = document.getElementById('buyMsg');

  try {
    if (!item.for_sale) return;

    // Normalize seller wallet with Ethers (fixes checksum errors)
    let sellerAddr;
    try {
      sellerAddr = ethers.utils.getAddress(
        (item.profiles?.usdc_base_address || '').trim()
      );
    } catch {
      console.warn('Invalid or missing seller wallet');
      return;
    }
    
    buyCard.style.display = 'block';

    buyBtn.addEventListener('click', async () => {
      buyMsg.textContent = 'Connecting wallet...';
      if (!window.ethereum) {
        buyMsg.textContent = 'No wallet found (MetaMask / Coinbase).';
        return;
      }

      const provider = new ethers.providers.Web3Provider(window.ethereum);
      await provider.send('eth_requestAccounts', []);
      const signer = provider.getSigner();

      const network = await provider.getNetwork();
      if (network.chainId !== 8453) {
        buyMsg.textContent = 'Please switch to Base network.';
        return;
      }

      const usdc = new ethers.Contract(USDC_BASE, USDC_ABI, signer);
      const price = ethers.utils.parseUnits(item.user_value.toString(), 6);

      buyMsg.textContent = 'Sending payment...';
      try {
        const tx = await usdc.transfer(sellerAddr, price);
        buyMsg.textContent = 'Waiting for confirmation...';
        await tx.wait();
        buyMsg.textContent = '✅ Payment complete! Tx hash: ' + tx.hash;
      } catch (err) {
        console.error(err);
        buyMsg.textContent = 'Payment failed: ' + (err.message || err);
      }
    });
  } catch (e) {
    console.error(e);
  }
}
</script>
</body>
</html>
