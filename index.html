<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Scream Collector — Home</title>
<style>
  :root{--bg:#111;--panel:#1b1b1b;--ink:#eee;--muted:#a9adb4;--accent:#dc143c}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:Arial,Helvetica,sans-serif}
  .wrap{max-width:1100px;margin:0 auto;padding:24px}
  a{color:#9ecbff;text-decoration:none}
  .top{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:10px}
  .btn{background:#444;color:#fff;border:none;border-radius:8px;padding:8px 12px;cursor:pointer;text-decoration:none}
  .card{background:var(--panel);border-radius:12px;padding:16px;margin-top:16px}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:14px}
  .tile{display:block;color:inherit;text-decoration:none;background:#161616;border:1px solid #2a2a2a;border-radius:12px;overflow:hidden}
  .thumb{height:160px;background:#222;display:flex;align-items:center;justify-content:center}
  .thumb img{max-width:100%;max-height:100%}
  .meta{padding:10px}
  .muted{color:var(--muted)}
</style>
</head>
<body>
<app-menu></app-menu>
<script type="module" src="/menu.js"></script>

<div class="wrap">
  <div class="top">
    <h2 style="margin:0">Recent Items</h2>
    <a class="btn" href="create.html">Add Item</a>
    <a class="btn" href="users.html">Users</a>
    <a class="btn" href="settings.html">Settings</a>
  </div>

  <div class="card">
    <div id="msg" class="muted">Loading…</div>
    <div id="list" class="grid"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const sb = supabase.createClient(
  'https://wktxpukjmvmhzpctttjx.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndrdHhwdWtqbXZtaHpwY3R0dGp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxMjg2MjAsImV4cCI6MjA3MTcwNDYyMH0.07xzRjb_iQlkaObfslKiL9VZIHT8P3vnK-ZkIVm2qVY'
);

// helper: attach first photo as preview_url
async function attachPreviews(items) {
  if (!items?.length) return items;
  const ids = items.map(i => i.id);
  const { data: imgs } = await sb
    .from('items_images')
    .select('item_id,image_url,position,created_at')
    .in('item_id', ids)
    .order('position', {ascending:true})
    .order('created_at', {ascending:true});
  const first = {};
  (imgs||[]).forEach(im => { if (!first[im.item_id]) first[im.item_id] = im.image_url; });
  return items.map(i => ({...i, preview_url:first[i.id]||null}));
}

const listEl = document.getElementById('list');
const msgEl  = document.getElementById('msg');

(async function load(){
  const { data: items, error } = await sb
    .from('items')
    .select('id,title,user_value,created_at')
    .order('created_at',{ascending:false})
    .limit(24);
  if (error){ msgEl.textContent = 'Error: '+error.message; return; }
  const withPrev = await attachPreviews(items);
  msgEl.textContent = withPrev?.length ? '' : 'No items yet.';
  listEl.innerHTML = (withPrev||[]).map(it=>`
    <a class="tile" href="item.html?id=${it.id}">
      <div class="thumb">${it.preview_url ? `<img src="${it.preview_url}" alt="">` : '<span class="muted">No image</span>'}</div>
      <div class="meta"><strong>${it.title}</strong><br class="muted">$${(it.user_value||0).toLocaleString()}</div>
    </a>
  `).join('');
})();
</script>
</body>
</html>
