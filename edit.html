<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Edit Item</title>
<style>
  body{margin:0;background:#111;color:#eee;font-family:Arial,Helvetica,sans-serif}
  .wrap{max-width:900px;margin:0 auto;padding:24px}
  a{color:#9ecbff;text-decoration:none}
  .card{background:#1c1c1c;border-radius:12px;padding:16px;margin-top:16px}
  .muted{opacity:.75}.err{color:#f88}.ok{color:#9f9}
  .row{display:grid;grid-template-columns:160px 1fr;gap:16px;align-items:center}
  input,textarea,button{padding:10px;border-radius:8px;border:1px solid #333;background:#222;color:#eee}
  button{border:none;background:#2a6;cursor:pointer}
  .tools{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
</style>
</head>
<body>
<app-menu></app-menu>
<script type="module" src="/menu.js"></script>

<div class="wrap">
  <a href="portfolio.html">← Back</a>
  <h2>Edit Item</h2>
  <div id="msg" class="muted"></div>

  <div class="card">
    <div class="row">
      <label>Title</label>
      <input id="title" placeholder="Title"/>
    </div>
    <div class="row">
      <label>Description</label>
      <textarea id="desc" placeholder="Description" style="min-height:120px"></textarea>
    </div>
    <div class="row">
      <label>My Value (USD)</label>
      <input id="value" type="number" step="1" min="0" placeholder="0"/>
    </div>
    <div class="tools">
      <button id="save">Save</button>
      <a id="view" href="#" style="background:#444;text-decoration:none">View</a>
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 8px">Selling (USDC on Base)</h3>
    <div class="tools">
      <label style="display:flex;align-items:center;gap:8px">
        <input type="checkbox" id="sellToggle"> Enable selling
      </label>
      <input id="sellPriceUsdc" type="number" step="0.01" min="0.01" placeholder="Price in USDC" style="width:160px">
      <span id="sellNote" class="muted">Requires subscriber (or moderator/owner) and your USDC wallet in Settings.</span>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const sb = supabase.createClient(
  'https://wktxpukjmvmhzpctttjx.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndrdHhwdWtqbXZtaHpwY3R0dGp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxMjg2MjAsImV4cCI6MjA3MTcwNDYyMH0.07xzRjb_iQlkaObfslKiL9VZIHT8P3vnK-ZkIVm2qVY'
);

const qs = new URLSearchParams(location.search);
const itemId = qs.get('id');

const titleEl = document.getElementById('title');
const descEl = document.getElementById('desc');
const valueEl = document.getElementById('value');
const saveBtn = document.getElementById('save');
const viewBtn = document.getElementById('view');
const msgEl  = document.getElementById('msg');

// selling
const sellToggle = document.getElementById('sellToggle');
const sellPriceUsdc = document.getElementById('sellPriceUsdc');
const sellNote = document.getElementById('sellNote');

let me=null, myRole='free', myWallet=null, item=null;

function setMsg(t, cls='muted'){ msgEl.className=cls; msgEl.textContent=t; }

(async function init(){
  if(!itemId){ location.href='portfolio.html'; return; }
  const { data:{ session } } = await sb.auth.getSession();
  if(!session){ location.href='login.html?next='+encodeURIComponent('edit.html?id='+itemId); return; }
  me = session.user;

  // my role + wallet
  const { data: prof } = await sb.from('profiles').select('role,usdc_base_address').eq('id', me.id).maybeSingle();
  myRole   = prof?.role || 'free';
  myWallet = prof?.usdc_base_address || null;

  const { data } = await sb.from('items').select('id,title,description,user_value,is_for_sale,price_usdc,sale_currency,owner_id').eq('id', itemId).maybeSingle();
  item = data;
  if(!item){ setMsg('Item not found','err'); return; }
  if(item.owner_id!==me.id){ setMsg('You do not own this item.','err'); return; }

  titleEl.value = item.title || '';
  descEl.value  = item.description || '';
  valueEl.value = item.user_value || 0;
  viewBtn.href  = 'item.html?id='+item.id;

  sellToggle.checked = !!item.is_for_sale;
  sellPriceUsdc.value = item.price_usdc ? (Number(item.price_usdc)/1_000_000).toFixed(2) : '';
})();

saveBtn.addEventListener('click', async ()=>{
  if(!item) return;
  setMsg('Saving…');

  // role gating
  const isSellerRole = (myRole==='subscriber'||myRole==='moderator'||myRole==='owner');

  let enable = isSellerRole && !!sellToggle.checked;
  if (enable && !myWallet){
    sellNote.textContent='Add your USDC (Base) wallet in Settings first.'; sellNote.className='err';
    enable=false;
  }

  let priceMicros = 0;
  if (enable){
    const parsed = Number(sellPriceUsdc.value||0);
    if (!(parsed>0)){ sellNote.textContent='Enter a valid price in USDC.'; sellNote.className='err'; setMsg('Fix selling fields.','err'); return; }
    priceMicros = Math.round(parsed*1_000_000);
    sellNote.className='muted'; sellNote.textContent='Selling enabled.';
  }

  const updates = {
    title: (titleEl.value||'').trim(),
    description: (descEl.value||'').trim(),
    user_value: Number(valueEl.value||0),
    is_for_sale: enable,
    price_usdc: priceMicros,
    sale_currency: 'USDC_BASE'
  };

  const { error } = await sb.from('items').update(updates).eq('id', item.id);
  if(error){ setMsg('Error: '+error.message,'err'); return; }
  setMsg('Saved!','ok');
});
</script>
</body>
</html>
