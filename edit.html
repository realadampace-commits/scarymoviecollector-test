<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Edit Item ‚Äî Scream Collector</title>
<style>
  :root{--bg:#111;--panel:#1b1b1b;--ink:#eee;--muted:#a9adb4;--accent:#dc143c;--ok:#2a6}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:Arial,Helvetica,sans-serif}
  a{color:#9ecbff;text-decoration:none}
  .wrap{max-width:960px;margin:0 auto;padding:24px}
  .card{background:var(--panel);border-radius:12px;padding:16px;margin-top:16px}
  .muted{color:var(--muted)} .ok{color:#9f9}.err{color:#f88}
  input,textarea,button{padding:10px;border-radius:8px;border:1px solid #333;background:#222;color:#eee}
  input,textarea{width:100%}
  button{border:none;background:var(--accent);cursor:pointer}
  button[disabled]{opacity:.5;cursor:not-allowed}
  .row{display:grid;grid-template-columns:180px 1fr;gap:14px;align-items:center}
  .small{font-size:12px;opacity:.8}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px}
  .tile{position:relative;background:#161616;border:1px solid #2a2a2a;border-radius:12px;overflow:hidden}
  .tile img{width:100%;height:140px;object-fit:cover;display:block}
  .tile .bar{display:flex;align-items:center;justify-content:space-between;padding:8px}
  .tile input[type=checkbox]{transform:scale(1.2)}
  .tools{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .btn{padding:8px 12px;border:none;border-radius:8px;cursor:pointer}
  .btn.del{background:#933}
  .btn.add{background:var(--ok)}
  .actions{display:flex;gap:10px;align-items:center}
</style>
</head>
<body>
<app-menu></app-menu>
<script type="module" src="/menu.js"></script>

<div class="wrap">
  <a href="#" id="backLink">‚Üê Back to item</a>
  <h2 style="display:flex;align-items:center;gap:10px">
    Edit Item
    <span id="permNote" class="small muted"></span>
  </h2>

  <!-- Details -->
  <div class="card">
    <div class="row"><label for="title">Title</label><input id="title" placeholder="Item title"></div>
    <div class="row"><label for="price">Your value ($)</label><input id="price" type="number" min="0" step="1" placeholder="e.g. 150"></div>
    <div class="row" style="align-items:start"><label for="desc" style="padding-top:10px">Description</label><textarea id="desc" rows="5" placeholder="Describe the item‚Ä¶"></textarea></div>

    <div class="actions" style="margin-top:12px">
      <button id="saveDetails">Save changes</button>
      <span id="detailsMsg" class="muted"></span>
    </div>
    <div class="small" style="margin-top:6px">Owners and moderators can edit these fields.</div>
  </div>

  <!-- Photos -->
  <div class="card">
    <div class="tools">
      <strong>Photos</strong>
      <span id="capMsg" class="muted"></span>
    </div>

    <div id="grid" class="grid" style="margin-top:10px"></div>

    <div class="tools" style="margin-top:12px">
      <input id="newFiles" type="file" accept="image/*" multiple />
      <button id="addBtn" class="btn add">Upload</button>
      <button id="delBtn" class="btn del">Delete Selected</button>
      <span id="msg" class="muted"></span>
    </div>
    <div class="small" style="margin-top:6px">Up to 5 images total. First image is treated as the main image.</div>
  </div> <!-- üß± close Photos card -->

  <!-- Buy -->
  <div class="card">
    <h3 style="margin:0 0 8px">Selling (USDC on Base)</h3>
    <div class="tools">
      <label style="display:flex;align-items:center;gap:8px">
        <input type="checkbox" id="sellToggle"> Enable selling
      </label>
      <input id="sellPriceUsdc" type="number" step="0.01" min="0.01" placeholder="Price in USDC" style="width:160px">
      <button id="saveSelling" style="background:#2a6">Save Selling</button>
      <span id="sellNote" class="muted">Requires subscriber/moderator/owner + your USDC wallet in Settings.</span>
    </div>
  </div>

  <!-- Sold -->
  <div class="card" id="soldPanel" style="margin-top:16px">
    <h3 style="margin:0 0 8px">Sale Status</h3>
    <div id="soldState" class="muted" style="margin:0 0 8px">Loading‚Ä¶</div>
    <div id="soldControls">
      <label>Sold price (USD): </label>
      <input id="soldPrice" type="number" min="0" step="1" style="width:140px">
      <button id="markSold" class="btn" style="background:#2a6;margin-left:8px">Mark as Sold</button>
      <button id="undoSold" class="btn" style="background:#444;margin-left:8px;display:none">Undo Sale</button>
      <span id="soldMsg" class="muted" style="margin-left:10px"></span>
    </div>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const sb = supabase.createClient(
  'https://wktxpukjmvmhzpctttjx.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndrdHhwdWtqbXZtaHpwY3R0dGp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxMjg2MjAsImV4cCI6MjA3MTcwNDYyMH0.07xzRjb_iQlkaObfslKiL9VZIHT8P3vnK-ZkIVm2qVY'
);
const BUCKET='item-images';

const qs=new URLSearchParams(location.search);
const itemId=qs.get('id');

const backLink=document.getElementById('backLink');
backLink.href='item.html?id='+itemId;

const permNote=document.getElementById('permNote');

const titleEl=document.getElementById('title');
const priceEl=document.getElementById('price');
const descEl=document.getElementById('desc');
const saveDetails=document.getElementById('saveDetails');
const detailsMsg=document.getElementById('detailsMsg');

const grid=document.getElementById('grid');
const newFiles=document.getElementById('newFiles');
const addBtn=document.getElementById('addBtn');
const delBtn=document.getElementById('delBtn');
const msgEl=document.getElementById('msg');
const capMsg=document.getElementById('capMsg');

const soldPanel = document.getElementById('soldPanel');
const soldState = document.getElementById('soldState');
const soldPriceEl = document.getElementById('soldPrice');
const markSoldBtn = document.getElementById('markSold');
const undoSoldBtn = document.getElementById('undoSold');
const soldMsg = document.getElementById('soldMsg');

const sellToggle     = document.getElementById('sellToggle');
const sellPriceUsdc  = document.getElementById('sellPriceUsdc');
const saveSellingBtn = document.getElementById('saveSelling');
const sellNote       = document.getElementById('sellNote');

let me=null, myRole='free', ownerId=null;
let images=[];

function msg(t, cls='muted'){ msgEl.className=cls; msgEl.textContent=t; }
function dmsg(t, cls='muted'){ detailsMsg.className=cls; detailsMsg.textContent=t; }

function setEditable(enabled){
  [titleEl, priceEl, descEl, newFiles, addBtn, delBtn, saveDetails,
   sellToggle, sellPriceUsdc, saveSellingBtn,
   soldPriceEl, markSoldBtn, undoSoldBtn
  ].forEach(el=>{ if(el){ el.disabled = !enabled; }});
  if (!enabled){
    dmsg('You can view this item, but you do not have permission to edit it.', 'err');
  } else {
    dmsg('', 'muted');
  }
}

(async function init(){
  if(!itemId){ alert('Missing item id'); location.href='index.html'; return; }

  const { data:{ session } } = await sb.auth.getSession();
  if(!session){ alert('Please sign in.'); location.href='login.html?next='+encodeURIComponent('edit.html?id='+itemId); return; }
  me = session.user;

  // role
  const vp = await sb.from('profiles').select('role').eq('id', me.id).maybeSingle();
  myRole = vp.data?.role || 'free';

  // ------- STEP 1: minimal fetch so RLS/column perms don't block -------
  let core = await sb.from('items')
    .select('id,owner_id')
    .eq('id', itemId)
    .maybeSingle();

  // If not found, retry with numeric id (helps when ?id="123" but id is integer)
  if (!core.data) {
    const maybeInt = Number(itemId);
    if (Number.isFinite(maybeInt)) {
      core = await sb.from('items')
        .select('id,owner_id')
        .eq('id', maybeInt)
        .maybeSingle();
    }
  }

  if (core.error) {
    console.warn('[edit] core fetch error:', core.error);
  }
  if (!core.data) {
    // Show message inline instead of redirecting ‚Äî easier to debug
    detailsMsg.className = 'err';
    detailsMsg.textContent = 'Item not found or not accessible. (Core fetch)';
    return;
  }

  // normalize the resolved id (in case numeric retry worked)
  const resolvedId = core.data.id;
  ownerId = core.data.owner_id ?? null;

  // ------- Permission: elevated roles OR owner match (if owner_id visible) -------
  const ownerMatch = (ownerId != null) ? (String(ownerId) === String(me.id)) : true; // optimistic if hidden
  const isElevated = (myRole === 'owner' || myRole === 'moderator');
  const canEdit = isElevated || ownerMatch;

  permNote.textContent = canEdit
    ? `(role: ${myRole} ‚Äî editing enabled)`
    : `(role: ${myRole} ‚Äî view only)`;
  setEditable(canEdit);

  // ------- STEP 2: fetch the rest of the editable/display fields -------
  const full = await sb.from('items')
    .select('title,description,user_value,sold,sold_price,sold_at')
    .eq('id', resolvedId)
    .maybeSingle();

  if (full.error) console.warn('[edit] full fetch error:', full.error);

  // Even if some fields are hidden by column privileges, use what we can safely
  const row = full.data || {};
  titleEl.value = row.title || '';
  descEl.value  = row.description || '';
  priceEl.value = (row.user_value ?? '') === null ? '' : row.user_value;

  await refreshImages();

  // Sold panel: render with partial data if necessary
  renderSoldPanel({
    sold: row.sold ?? false,
    sold_price: row.sold_price ?? null,
    sold_at: row.sold_at ?? null
  });
})();
  
function renderSoldPanel(row){
  if (!row) { soldPanel.style.display='none'; return; }
  const isSold = !!row.sold;
  if (isSold){
    soldState.textContent = `Sold for $${Number(row.sold_price||0).toLocaleString()} on ${new Date(row.sold_at).toLocaleString()}`;
    soldPriceEl.value = row.sold_price ?? '';
    markSoldBtn.style.display = 'none';
    undoSoldBtn.style.display = '';
  } else {
    soldState.textContent = 'Not sold';
    markSoldBtn.style.display = '';
    undoSoldBtn.style.display = 'none';
  }
}

markSoldBtn.addEventListener('click', async ()=>{
  const price = Math.round(Number(soldPriceEl.value||0));
  if (!(price > 0)) { soldMsg.textContent = 'Enter a positive sold price.'; return; }
  soldMsg.textContent = 'Saving‚Ä¶';
  const { error, data } = await sb.from('items')
    .update({ sold:true, sold_price:price, sold_at:new Date().toISOString(), is_for_sale:false })
    .eq('id', itemId)
    .select('sold,sold_price,sold_at').maybeSingle();
  soldMsg.textContent = error ? ('Error: ' + error.message) : 'Marked as sold.';
  if (!error) renderSoldPanel(data);
});

undoSoldBtn.addEventListener('click', async ()=>{
  if (!confirm('Undo sale and mark item as not sold?')) return;
  soldMsg.textContent = 'Saving‚Ä¶';
  const { error, data } = await sb.from('items')
    .update({ sold:false, sold_price:null, sold_at:null })
    .eq('id', itemId)
    .select('sold,sold_price,sold_at').maybeSingle();
  soldMsg.textContent = error ? ('Error: ' + error.message) : 'Sale undone.';
  if (!error) renderSoldPanel(data);
});

saveDetails.addEventListener('click', async ()=>{
  const title = titleEl.value.trim();
  const description = descEl.value.trim();
  const user_value = Number(priceEl.value || 0);

  if (!title) return dmsg('Title is required.', 'err');
  if (!(user_value >= 0)) return dmsg('Enter a valid price (0 or higher).', 'err');

  dmsg('Saving‚Ä¶');
  const { error } = await sb.from('items')
    .update({ title, description, user_value })
    .eq('id', itemId);
  if (error) return dmsg('Save error: ' + error.message, 'err');

  dmsg('Saved!', 'ok');
});

// --------- Photos ----------
async function refreshImages(){
  const { data } = await sb.from('items_images')
    .select('id,image_url,position,created_at')
    .eq('item_id', itemId)
    .order('position', {ascending:true})
    .order('created_at', {ascending:true});
  images = data || [];
  capMsg.textContent = `(${images.length}/5 used)`;
  renderGrid();
}

function renderGrid(){
  if (!images.length){ grid.innerHTML = '<div class="muted">No photos yet.</div>'; return; }
  grid.innerHTML = images.map(img => `
    <div class="tile" data-id="${img.id}">
      <img src="${img.image_url}" alt="">
      <div class="bar">
        <span class="muted">pos ${img.position+1}</span>
        <input type="checkbox" class="chk" title="Select to delete">
      </div>
    </div>
  `).join('');
}

addBtn.addEventListener('click', async ()=>{
  if (!newFiles.files.length) return msg('Choose images first.', 'err');
  const remaining = 5 - images.length;
  const files = Array.from(newFiles.files).slice(0, remaining);
  if (files.length < newFiles.files.length) msg('Only the first '+remaining+' will be uploaded.', 'err');

  let pos = images.length;
  for (const f of files) {
    const safe = f.name.replace(/[^\w.\-]+/g,'_');
    const path = `${itemId}/${Date.now()}-${pos}-${safe}`;
    const up = await sb.storage.from(BUCKET).upload(path, f, { upsert:true, contentType:f.type });
    if (up.error) { return msg('Upload error: ' + up.error.message, 'err'); }
    const pub = sb.storage.from(BUCKET).getPublicUrl(path).data.publicUrl;
    const ins = await sb.from('items_images').insert({ item_id:itemId, image_url:pub, position:pos });
    if (ins.error) { return msg('Save error: ' + ins.error.message, 'err'); }
    pos++;
  }
  newFiles.value = '';
  msg('Uploaded!', 'ok');
  await refreshImages();
});

delBtn.addEventListener('click', async ()=>{
  const picks = Array.from(grid.querySelectorAll('.tile')).filter(t => t.querySelector('.chk').checked);
  if (!picks.length) return msg('Select photos to delete.', 'err');
  if (!confirm('Delete selected photos?')) return;

  for (const tile of picks) {
    const id = tile.dataset.id;
    const del = await sb.from('items_images').delete().eq('id', id);
    if (del.error) return msg('Delete error: ' + del.error.message, 'err');
  }
  msg('Deleted.', 'ok');
  await refreshImages();
});

// === Selling (USDC on Base) ===
let _sellerRole = 'free', _sellerWallet = null, _editItemId = null;
async function initSellingBlock(){
  try{
    _editItemId = itemId;
    const { data:{ session } } = await sb.auth.getSession();
    if (!session || !_editItemId) return;

    // reuse role we already fetched
    _sellerRole = myRole;
    const { data: mep } = await sb.from('profiles').select('usdc_base_address').eq('id', session.user.id).maybeSingle();
    _sellerWallet = mep?.usdc_base_address || null;

    const { data: it } = await sb.from('items').select('is_for_sale,price_usdc,sale_currency,owner_id').eq('id', _editItemId).maybeSingle();
    if (it){
      if (sellToggle) sellToggle.checked = !!it.is_for_sale;
      if (sellPriceUsdc && it.price_usdc) sellPriceUsdc.value = (Number(it.price_usdc)/1_000_000).toFixed(2);
    }

    if ((_sellerRole==='subscriber' || _sellerRole==='moderator' || _sellerRole==='owner')){
      if (!_sellerWallet) { sellNote.className='err'; sellNote.textContent='Add your USDC (Base) wallet in Settings first.'; }
    } else {
      sellNote.className='err'; sellNote.textContent='Selling requires a subscriber (or higher) role.';
    }
  }catch(_e){}
}

saveSellingBtn?.addEventListener('click', async ()=>{
  try{
    const { data:{ session } } = await sb.auth.getSession();
    if (!session || !_editItemId) return;

    const roleOK = (_sellerRole==='subscriber' || _sellerRole==='moderator' || _sellerRole==='owner');
    let enable = roleOK && !!sellToggle?.checked;
    if (enable && !_sellerWallet){ sellNote.className='err'; sellNote.textContent='Add your USDC (Base) wallet in Settings.'; enable = false; }

    let priceMicros = 0;
    if (enable){
      const p = Number(sellPriceUsdc?.value || 0);
      if (!(p > 0)){ sellNote.className='err'; sellNote.textContent='Enter a valid USDC price.'; return; }
      priceMicros = Math.round(p * 1_000_000);
    }

    const updates = { is_for_sale: enable, price_usdc: priceMicros, sale_currency: enable ? 'USDC_BASE' : null };
    const { error } = await sb.from('items').update(updates).eq('id', _editItemId);
    if (error){ sellNote.className='err'; sellNote.textContent='Error: ' + error.message; return; }
    sellNote.className='ok'; sellNote.textContent = enable ? 'Selling enabled.' : 'Selling disabled.';
  }catch(e){
    sellNote.className='err'; sellNote.textContent = 'Error: ' + (e?.message || e);
  }
});
</script>
</body>
</html>


